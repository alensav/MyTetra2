<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:x-large; font-weight:600;">Настраиваем rsync за 5 минут.</span> </p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Май 11, 2011 <a href="https://k0n0n3nk0.wordpress.com/author/k0n0n3nk0/"><span style=" text-decoration: underline; color:#0000ff;">NicK</span></a> <a href="https://k0n0n3nk0.wordpress.com/2011/05/11/%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%B0%D0%B8%D0%B2%D0%B0%D0%B5%D0%BC-rsync-%D0%B7%D0%B0-5-%D0%BC%D0%B8%D0%BD%D1%83%D1%82/#respond"><span style=" text-decoration: underline; color:#0000ff;">Оставьте комментарий</span></a> <a href="https://k0n0n3nk0.wordpress.com/2011/05/11/%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%B0%D0%B8%D0%B2%D0%B0%D0%B5%D0%BC-rsync-%D0%B7%D0%B0-5-%D0%BC%D0%B8%D0%BD%D1%83%D1%82/#comments"><span style=" text-decoration: underline; color:#0000ff;">Go to comments</span></a> <a name="pd_rating_holder_1188980_post_293"></a> <a name="PDRTJS_1188980_post_293_stars_2"></a> <a name="PDRTJS_1188980_post_293_stars_4"></a> </p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:1px; -qt-block-indent:0; text-indent:0px; line-height:16px;"><a name="PDRTJS_1188980_post_293_stars_5"></a>  </p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="rating_info_1188980_post_293"></a>Rate This<br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Введение </span><br />Реализация Rsync-сервера построена следующим образом. Есть отдельный сервер куда будут складываться все бэкапы. С этого сервера запускается по крону команда rsync с параметрами, которая реализует коннект к удаленным машинам в сети. На всех машинах работает Rsync-служба, в конфиге которой прописано какие именно каталоги нужно синхронизировать.<br /><span style=" font-weight:600;">Настройка Rsync — службы, на удаленных серверах</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Устанавливаем все необходимое:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"># yum -y install rsync xinetd</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Добавляем в атозагрузку сервис xinetd:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"># chkconfig —add xinetd</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Разрешаем rsync:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"># vim /etc/xinetd.d/rsync</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Меняем disable = yes на disable = no и сохраняем изменения.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Пишем конфигурацию для демона rsync:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"># vim /etc/rsyncd.conf</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;">pid file = /var/run/rsyncd.pid</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"># Файл приветствия (информация о самом сервере, полезно когда серверов будет много)<br />motd file = /etc/rsync.motd</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"># Файл логов<br />log file = /var/log/rsyncd.log</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"># Писать в лог о скачиваемых файлах<br />transfer logging = true</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"># Описание секции для синхронизации /etc/<br />[etc]<br />path = /etc/<br />uid = root<br />read only = yes<br />list = yes<br />comment = etc directory<br />hosts allow = 192.168.1.19,192.168.1.201<br />#разрешенные пользователи для доступа:<br />auth users = backup<br />secrets file = /etc/rsyncd.scrt </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Теперь создадим файл приветствия, и файл для логов. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"># vim /etc/rsync.motd</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;">#################################################################</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;">Hello from rsync server<br />Server Adress : 192.168.1.198 </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;">#################################################################</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"># touch /var/log/rsyncd.log<br /># chmod 0600 /var/log/rsyncd.log<br /># chown root:wheel /var/log/rsyncd.log<br /># cat &gt; /etc/rsyncd.scrt<br />admin:passwd</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"># chown root:wheel /etc/rsyncd.scrt<br /># chmod 0600 /etc/rsyncd.scrt </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Настройка Rsync — скрипта, на BackUp — сервере</span><br /></p>
<hr />
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />На BackUp — сервере создаем директории, куда будут складываться все резервные копии. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"># mkdir -p /home/backup/192.168.1.198/etc<br /># chmod -R 0700 /home/backup/192.168.1.198/etc</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Создаем файл с паролем.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"># cat &gt; /etc/rsyncd.scrt<br />passwd</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Задаем права доступа:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"># chown root:wheel /etc/rsyncd.scrt<br /># chmod 0600 /etc/rsyncd.scrt</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Проверяем:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"># rsync 192.168.1.198::<br />#################################################################</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;">Hello from rsync server<br />Server Address : 192.168.1.198 </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;">#################################################################</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Теперь делаем полную синхронизацию:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;">rsync -uvroghtp —progress —delete-after —password-file=/etc/rsyncd.scrt admin@192.168.1.198::backup /etc/BACKUP/server/ </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Детальное описание ключей rsync</span><br />-v, —verbose увеличение отладочной информации<br />-u, —update пропускать обновление файлов, которые новее исходных<br />-r, —recursive рекурсия в директориях<br />-o, —owner сохранить владельца (только под root)<br />-g, —group сохранить группу<br />-h, —human-readable вывод цифр в читаемом виде (Кб, Мб, Гб)<br />-t, —times сохранить дату изменения<br />-p, —perms сохранить права доступа</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">—delete-after удалить после. Если в основном месте был удален какой-то файл, или каталог,<br />то после синхронизации в backup сервере, в каталоге он тоже будет удален<br />—password-file Путь, где находится файл с паролем.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Обязательно включите ключ -v, —verbose, тогда в консоль вам будет выводиться вся информация о процессе. Если у вас настроено отсылка сообщений службой ssmtp, то вы сможете получать письма с информацией о том как отработал cron. И соответственно как прошла синхронизация.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для автоматизации можно добавить задание в крон.</p></body></html>