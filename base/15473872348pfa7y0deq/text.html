<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:x-large; font-weight:600;">Зачем нужен Docker и практика работы с ним</span> </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">16 февраля 2015 </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://www.docker.com"><span style=" text-decoration: underline; color:#0000ff;">Docker</span></a> — это инструмент, предоставляющий удобный интерфейс для работы с <a href="https://eax.me/lxc/"><span style=" text-decoration: underline; color:#0000ff;">LXC</span></a>. С помощью Docker вы можете запускать процессы в изолированном окружении. Процессу, запущенному под Docker, кажется, что он работает в минимальном окружении, где помимо него есть только его дети. Хотя при этом процесс работает в той же операционной системе, что и остальные, нормальные, процессы, он просто их не видит, ровно как не видит файлов и всего остального за пределами своей «песочницы». Можно думать о Docker, как о прокачанном chroot или аналоге FreeBSD Jails для Linux. Ну и в добавок вокруг всего этого накручена тонна маркетинговой лапши, дескать «Docker является платформой для распределенных приложений» и прочее в таком духе. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Зачем нужен Docker, если есть тот же <a href="https://eax.me/vagrant/"><span style=" text-decoration: underline; color:#0000ff;">Vagrant</span></a>? Главным образом, просто потому что виртуализация в Docker дешевле. Используя Vagrant, вы эмулируете работу целой операционной системы, тогда как Docker позволяет изолировать просто один процесс. Соответственно, используя одно и то же железо, с помощью Docker вы можете создать больше виртуальных окружений, чем при помощи Vagrant. Более того, LXC контейнеры запускаются (и останавливаются тоже) практически моментально, так как в них не происходит загрузка отдельной ОС. К тому же, Docker использует «слоеную» файловую систему <a href="http://aufs.sourceforge.net"><span style=" text-decoration: underline; color:#0000ff;">AuFS</span></a>, благодаря которой контейнеры могут совместно использовать одинаковые части файловой системы, доступные только на чтение. Если образ файловой системы занимает 5 Гб и вы запускаете 100 виртуальных окружений, то Vagrant потребуется 500 Гб места, а Docker — на порядок меньше. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Ну понятно, то есть, Docker во всем лучше Vagrant? На самом деле — нет. Docker не позволит вам запустить Windows, если вы сидите под Ubuntu. Слои AuFS накапливаются, из-за чего <a href="http://habrahabr.ru/post/234829/"><span style=" text-decoration: underline; color:#0000ff;">приходится время от времени их «схлопывать»</span></a>, а также прибегать к другим трюкам. Отмечаются проблемы в безопасности и общая сложность Docker, из-за которых даже начались работы над <a href="http://www.opennet.ru/opennews/art.shtml?num=41168"><span style=" text-decoration: underline; color:#0000ff;">альтернативным проектом Rocket</span></a>. Наконец, в Docker есть целый ряд косяков, которые приходится либо обходить какими-то хаками, либо находить образы, <a href="http://phusion.github.io/baseimage-docker/"><span style=" text-decoration: underline; color:#0000ff;">в которых эти хаки уже расставили за тебя</span></a>.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В общем и целом, если вас всем устраивает Vagrant, скорее всего, вам нужен Vagrant, а не Docker.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Прежде, чем мы перейдем к основам работы с Docker, нужно отметить еще один момент. Есть как минимум два способа запуска приложений в Docker. Первый — просто запустить с тонной флагов, указывающих, куда писать логи, где брать конфиг, какой порт слушать и так далее (поскольку это просто запуск процесса, а не <span style=" font-family:'Courier New,courier';">sudo service ololo start</span>), скрестить пальчики и надеяться, что все будет хорошо, даже при условии, что в окружении нет корректного initd, syslog, crond, и так далее. Второй — использовать специальный образ, например, <a href="https://github.com/phusion/baseimage-docker"><span style=" text-decoration: underline; color:#0000ff;">baseimage</span></a>, в котором решены эти и многие другие проблемы, тупо зайти в окружение по ssh, настроить все по-человечески и запускать приложение в полном соответствии с ожиданиями его разработчиков.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Я лично всегда был сторонником второго способа, хотя находятся толпы людей, доказывающие с пеной у рта, что второй способ, видите ли, не идиоматичный, и единственным правильным способом является первый. Мне кажется, в этом вопросе <a href="https://twitter.com/umputun/status/538381351603666945"><span style=" text-decoration: underline; color:#0000ff;">Umputun’у можно поверить на слово</span></a>, поэтому далее будет описан второй подход.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Установка Docker. В Ubuntu 14.04 поставить Docker можно, воспользовавшись пакетом docker.io, но Docker вы в результате получите доисторический. Предпочтительнее воспользоваться <a href="https://docs.docker.com/installation/ubuntulinux/#docker-maintained-package-installation"><span style=" text-decoration: underline; color:#0000ff;">следующей последовательностью действий</span></a>:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 \<br />  --recv-keys 36A1D7869245C8950F966E92D8576A8BA88D21E9<br />sudo sh -c &quot;echo deb https://get.docker.com/ubuntu docker main \<br /> &gt; /etc/apt/sources.list.d/docker.list&quot;<br />sudo apt-get update<br />sudo apt-get install lxc-docker</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Аналогами боксов из мира Vagrant в мире Docker являются образы (image). Множество готовых образов с предустановленными <a href="https://eax.me/mongodb/"><span style=" text-decoration: underline; color:#0000ff;">MongoDB</span></a>, <a href="https://eax.me/wordpress/"><span style=" text-decoration: underline; color:#0000ff;">WordPress</span></a> и много чем еще можно найти в <a href="https://registry.hub.docker.com"><span style=" text-decoration: underline; color:#0000ff;">официальном реестре</span></a>. Мы с вами, как уже отмечалось, воспользуемся baseimage:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">sudo docker pull phusion/baseimage</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Запускаем контейнер:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">sudo docker run -i -t phusion/baseimage:latest /sbin/my_init -- bash -l</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Прописываем свой ключик в ~/.ssh/authorized_keys. Теперь важный момент. Если остановить контейнер, все сделанные в нем изменения откатятся. Поэтому нужно сохранить состояние контейнера в новый образ. В соседнем терминале смотрим список запущенных контейнеров:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">sudo docker ps</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Из списка нас сейчас интересует container id. Сохраняем образ и останавливаем контейнер:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">sudo docker commit 2fd baseimage-ssh<br />sudo docker stop 2fd</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Теперь запускаем новый образ (<span style=" font-family:'Courier New,courier';">-d</span> означает «демонизировать»):</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">sudo docker run -d -i -t baseimage-ssh /sbin/my_init</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">По умолчанию контейнеры как бы находятся за NAT — они могут свободно ходить в сеть, но из сети нельзя так просто попасть в контейнеры. При этом с точки зрения хост-системы контейнеры находятся в сети 172.17.42.0/16. Узнать IP конкретного контейнера можно командой:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">sudo docker inspect -f &quot;{{ .NetworkSettings.IPAddress }}&quot; 1bb</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Насколько я могу судить, на данный момент нет простого способа присвоить контейнеру заранее известный IP адрес. Однако можно забиндить порты контейнера на интерфейсы-порты хост-системы, а также заставить контейнеры видеть друг друга при помощи файлов /etc/hosts. Подробности описаны <a href="https://docs.docker.com/v1.4/userguide/dockerlinks/"><span style=" text-decoration: underline; color:#0000ff;">здесь</span></a>.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Давайте прибьем контейнер, затем запустим его снова, пробросив порт 22 контейнера на 127.0.0.1:222, и зайдем внутрь контейнера по ssh:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">sudo docker stop 1bb<br />sudo docker run --dns 192.168.0.1 -p 127.0.0.1:222:22 \<br />  -d -i -t baseimage-ssh /sbin/my_init<br />ssh -p 222 root@localhost</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Адрес DNS-сервера, используемого хост-системой, можно узнать, сказав:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">nm-tool | grep DNS</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вообще, я помню, что с Docker из пакета docker.io все хорошо работало без параметра <span style=" font-family:'Courier New,courier';">--dns</span>. Либо что-то сломали, либо это как-то зависит от конкретной сети, ибо при написании заметки без этого параметра из контейнера не получалось резолвить домены. К вопросу о косяках в Docker.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Итак, мы в системе! Теперь можно настраивать все и вся привычными нам средствами. Давайте, например, <a href="https://eax.me/nginx/"><span style=" text-decoration: underline; color:#0000ff;">поднимем Nginx</span></a>:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">apt-get update<br />apt-get install nginx<br />service nginx start<br />curl localhost</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Должны увидеть:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">&lt;!DOCTYPE html&gt;<br />&lt;html&gt;<br />&lt;head&gt;<br />&lt;title&gt;Welcome to nginx!&lt;/title&gt;<br />...</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Поскольку мы используем образ baseimage, а не совсем честную Ubuntu, для того, чтобы Nginx запускался при старте контейнера, нужно дополнительно отредактировать файл /etc/my_init.d/01_services.sh:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">#!/bin/sh<br /><br />service nginx start</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">А затем сказать:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">chmod a+x /etc/my_init.d/01_services.sh</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Теперь открываем терминал в хост-системе и сохраняем образ:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">sudo docker ps<br />sudo docker commit 25f baseimage-nginx<br />sudo docker stop 25f</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Запускаем получившийся образ и проверяем:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">sudo docker run \<br />  --name docker-nginx --dns 192.168.0.1 \<br />  -p 127.0.0.1:222:22 -p 127.0.0.1:8080:80 \<br />  -d -i -t baseimage-nginx /sbin/my_init<br /><br />curl localhost:8080</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Заметьте, что здесь мы присвоили контейнеру имя, а то сколько уже можно пользоваться этими хэшами? Остановить контейнер теперь можно так:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">sudo docker stop docker-nginx</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если вдруг вы ошиблись во время настройки контейнера, то можете либо откатиться к последней рабочей версии, либо починить текущую как-то так:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">sudo docker run -i -t baseimage-nginx:latest /sbin/my_init \<br />  --skip-startup-files -- bash -l</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Наконец, образы можно экспортировать:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">sudo docker save -o baseimage-nginx.img baseimage-nginx</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">… и импортировать:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">sudo docker load -i baseimage-nginx.img</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Кстати, экспортированные образы неплохо gzip’уются.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">За кадром остался еще целый ряд интересных вопросов, например, ограничение ресурсов, используемых контейнером, монтирование части файловой системы хоста в госте, взаимодействие контейнеров друг с другом или написание Dockerfile. Но во всем этом вы и без меня разберетесь при помощи <a href="https://docs.docker.com"><span style=" text-decoration: underline; color:#0000ff;">официальной документации</span></a>.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">А для каких целей вы используете Docker и используете ли его вообще?</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic;">Дополнение:</span> Также вас могут заинтересовать заметки <a href="https://eax.me/openvz/"><span style=" text-decoration: underline; color:#0000ff;">Контейнерная виртуализация при помощи OpenVZ</span></a> и <a href="https://eax.me/docker-gui-apps/"><span style=" text-decoration: underline; color:#0000ff;">Осилил запуск GUI-приложений в Docker</span></a>. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic;">Метки: </span><a href="https://eax.me/tag/linux/"><span style=" font-style:italic; text-decoration: underline; color:#0000ff;">Linux</span></a><span style=" font-style:italic;">, </span><a href="https://eax.me/tag/virtualization/"><span style=" font-style:italic; text-decoration: underline; color:#0000ff;">Виртуализация</span></a><span style=" font-style:italic;">.</span></p></body></html>