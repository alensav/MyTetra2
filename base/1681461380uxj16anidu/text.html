<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:xx-large; color:#333333;">Как подружить OpenHAB и Arduino. Способ #3: MQTT</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-weight:696; color:#798e98;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:8px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#6667a3;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:1.6%; background-color:#fbfdff;"><span style=" font-family:'Menlo,Monaco,Consolas,Courier New,Courier,monospace'; color:#4d4d4c;">/myhome/bedroom/temperature</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:1.6%; background-color:#fbfdff;"><span style=" font-family:'Menlo,Monaco,Consolas,Courier New,Courier,monospace'; color:#4d4d4c;">/myhome/bedroom/humidity </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:1.6%; background-color:#fbfdff;"><span style=" font-family:'Menlo,Monaco,Consolas,Courier New,Courier,monospace'; color:#4d4d4c;">/myhome/bedroom/luminosity</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#111111;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#111111;">Аналогично для кухни:<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:1.6%; background-color:#fbfdff;"><span style=" font-family:'Menlo,Monaco,Consolas,Courier New,Courier,monospace'; color:#4d4d4c;">/myhome/kitchen/temperature</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#111111;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#111111;">Теперь, подписавшись на любой из этих топиков, мы будем получать сообщения о состоянии каждого конкретного датчика. Но протокол также позволяет подписываться на всю ветку сразу. Чтобы получать в одной подписке данные со всех датчиков спальни, можно подписаться на топик<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:1.6%; background-color:#fbfdff;"><span style=" font-family:'Menlo,Monaco,Consolas,Courier New,Courier,monospace'; color:#4d4d4c;">/myhome/bedroom/#</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#111111;"><br />Такая структура удобна для понимания человеком, но дальнейшее использование MQTT показало, что значительно проще использовать всего две ветки: одну для обновления статуса элементов и другую — для отправки команд. Но об этом чуть позже.<br /><br />В своём проекте я использовал </span><a href="http://roboparts.ru/products/15880466"><span style=" text-decoration: underline; color:#548eaa; background-color:#000000;">Raspberry Pi model B+</span></a><span style=" color:#111111;"> с установленной </span><a href="http://www.raspberrypi.org/downloads/"><span style=" text-decoration: underline; color:#548eaa; background-color:#000000;">Raspbian</span></a><span style=" color:#111111;"> в качестве платформы для openHAB и </span><a href="http://roboparts.ru/products/4027771"><span style=" text-decoration: underline; color:#548eaa; background-color:#000000;">Arduino MEGA 2560</span></a><span style=" color:#111111;"> с установленным на ней </span><a href="http://roboparts.ru/products/4096839"><span style=" text-decoration: underline; color:#548eaa; background-color:#000000;">Ethernet Shield w5100</span></a><span style=" color:#111111;">. Также экспериментировал с Arduino Yun — всё тоже самое, только используем YunClient вместо EthernetClient.<br /><br />Оставим за скобками процесс установки openHAB, т.к. этому посвящено множество статей. Перейдём сразу к установке MQTT. Здесь всё просто, открываем консоль и устанавливаем:<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:1.6%; background-color:#fbfdff;"><span style=" font-family:'Menlo,Monaco,Consolas,Courier New,Courier,monospace'; color:#4d4d4c;">sudo apt-get install mosquitto</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#111111;"><br />Перезагружаемся и проверяем работоспособность (у меня при первой установке mosquitto никак не хотел запускаться при старте системы):<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:1.6%; background-color:#fbfdff;"><span style=" font-family:'Menlo,Monaco,Consolas,Courier New,Courier,monospace'; color:#4d4d4c;">sudo shutdown -r now</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#111111;"><br />После перезагрузки:<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:1.6%; background-color:#fbfdff;"><span style=" font-family:'Menlo,Monaco,Consolas,Courier New,Courier,monospace'; color:#4d4d4c;">sudo service mosquitto status</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#111111;"><br />В ответ должны получить:<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:1.6%; background-color:#fbfdff;"><span style=" font-family:'Menlo,Monaco,Consolas,Courier New,Courier,monospace'; color:#4d4d4c;">[ ok ] mosquitto is running.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#111111;"><br />Теперь необходимо установить binding для openHAB. Для этого выполняем:<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:1.6%; background-color:#fbfdff;"><span style=" font-family:'Menlo,Monaco,Consolas,Courier New,Courier,monospace'; color:#4d4d4c;">sudo apt-get install openhab-addon-binding-mqtt</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#111111;"><br />Или просто копируем файл org.openhab.binding.mqtt-1.6.2.jar (актуальная на сегодня версия) в папку /usr/share/openhab/addons/<br /><br />Перейдём к настройке openHAB:<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:1.6%; background-color:#fbfdff;"><span style=" font-family:'Menlo,Monaco,Consolas,Courier New,Courier,monospace'; color:#4d4d4c;">sudo nano /etc/openhab/configurations/openhab.cfg</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#111111;"><br />Здесь добавляем следующие строки:<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:1.6%; background-color:#fbfdff;"><span style=" font-family:'Menlo,Monaco,Consolas,Courier New,Courier,monospace'; color:#4d4d4c;">mqtt:mybroker.url=tcp:</span><span style=" font-family:'Menlo,Monaco,Consolas,Courier New,Courier,monospace'; color:#8e908c;">//localhost:1883</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:1.6%; background-color:#fbfdff;"><span style=" font-family:'Menlo,Monaco,Consolas,Courier New,Courier,monospace'; color:#4d4d4c;">mqtt-eventbus:broker=mybroker</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:1.6%; background-color:#fbfdff;"><span style=" font-family:'Menlo,Monaco,Consolas,Courier New,Courier,monospace'; color:#4d4d4c;">mqtt-eventbus:commandPublishTopic=/myhome/in/${item}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:1.6%; background-color:#fbfdff;"><span style=" font-family:'Menlo,Monaco,Consolas,Courier New,Courier,monospace'; color:#4d4d4c;">mqtt-eventbus:stateSubscribeTopic=/myhome/out/${item}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#111111;"><br />Ещё нам потребуются два Item, отвечающих за включение/выключение света на кухне:<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:1.6%; background-color:#fbfdff;"><span style=" font-family:'Menlo,Monaco,Consolas,Courier New,Courier,monospace'; color:#4d4d4c;">Switch	Kitchen_light1	</span><span style=" font-family:'Menlo,Monaco,Consolas,Courier New,Courier,monospace'; color:#718c00;">&quot;Кухня. Свет 1&quot;</span><span style=" font-family:'Menlo,Monaco,Consolas,Courier New,Courier,monospace'; color:#4d4d4c;">	&lt;light&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:1.6%; background-color:#fbfdff;"><span style=" font-family:'Menlo,Monaco,Consolas,Courier New,Courier,monospace'; color:#4d4d4c;">Switch	Kitchen_light2	</span><span style=" font-family:'Menlo,Monaco,Consolas,Courier New,Courier,monospace'; color:#718c00;">&quot;Кухня. Свет 2&quot;</span><span style=" font-family:'Menlo,Monaco,Consolas,Courier New,Courier,monospace'; color:#4d4d4c;">	&lt;light&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#111111;"><br />Не забываем добавить их в sitemap в любое удобное место. Перезапускаем openHAB:<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:1.6%; background-color:#fbfdff;"><span style=" font-family:'Menlo,Monaco,Consolas,Courier New,Courier,monospace'; color:#4d4d4c;">sudo service openhab restart</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#111111;"><br />Можно начинать экспериментировать! Подключаемся с любого устройства к серверу MQTT и подписываемся на топик /myhome/#. При каждом изменении статуса любого Item мы будем получать сообщение, в топике которого будет указано имя Item, а в тексте сообщения — его новый статус. Нам этого достаточно, перейдём к программированию микроконтроллера.<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" text-decoration: underline; color:#548eaa;">Код должен выглядеть примерно так</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#111111;"><br /><br />Недостающую библиотеку можно скачать здесь: </span><a href="https://github.com/knolleary/pubsubclient"><span style=" text-decoration: underline; color:#548eaa; background-color:#000000;">https://github.com/knolleary/pubsubclient</span></a><span style=" color:#111111;"><br /><br />Вот и всё. Прокомментирую только последний кусочек кода. Если управление освещением происходит напрямую через микроконтроллер, то необходимо передать новое состояние в openHAB. Это можно сделать непосредственно сразу после изменения состояния, либо раз в минуту передавать состояние всех контролируемых нагрузок.<br /><br />В завершении хочу дать ссылку на потрясающую статью, которая очень мне помогла во всём этом разобраться: </span><a href="http://www.instructables.com/id/Uber-Home-Automation-w-Arduino-Pi/?ALLSTEPS"><span style=" text-decoration: underline; color:#548eaa; background-color:#000000;">«Uber Home Automation w/ Arduino &amp; Pi»</span></a></p>
<p style=" margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:28.8px;"><span style=" font-weight:696; color:#444444;">Теги:</span><span style=" color:#548eaa;"> </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#548eaa;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://habr.com/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Barduino%5D"><span style=" font-weight:496; text-decoration: underline; color:#0000ff; background-color:#000000;">arduino</span></a></li>
<li style=" color:#548eaa;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://habr.com/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5BopenHAB%5D"><span style=" font-weight:496; text-decoration: underline; color:#0000ff; background-color:#000000;">openHAB</span></a></li>
<li style=" color:#548eaa;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://habr.com/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bmqtt%5D"><span style=" font-weight:496; text-decoration: underline; color:#0000ff; background-color:#000000;">mqtt</span></a></li></ul>
<p style=" margin-top:24px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:696; color:#444444;">Хабы:</span><span style=" color:#548eaa;"> </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" color:#548eaa;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://habr.com/ru/hub/DIY/"><span style=" font-weight:496; text-decoration: underline; color:#0000ff; background-color:#000000;">DIY или Сделай сам</span></a></li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><a name="counter-rating"></a><br /></p></body></html>