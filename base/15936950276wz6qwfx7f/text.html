<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu'; font-size:large; font-weight:600;">Настройка</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';">Все основные настройки для Cassandra лежат в папке</span><span style=" font-family:'Ubuntu'; font-style:italic;"> /etc/cassandra</span><span style=" font-family:'Ubuntu';">, основные из них следующие:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Ubuntu';" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">cassandra.yaml — отвечает за основные настройки;</li>
<li style=" font-family:'Ubuntu';" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">cassandra-env.sh — отвечает за настройку JVM;</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';">Логирование происходит в файл system.log, находящийся в папке </span><span style=" font-family:'Ubuntu'; font-style:italic;">/var/log/cassandra</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';">По умолчанию Cassandra поднимает кластер с одним узлом. Если есть необходимость поднять несколько узлов, то необходимо удалить старые данные:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ service cassandra stop<br />$ rm -rf /var/lib/cassandra/data/system/*</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';">И для каждого узла настроить следующие параметры в </span><span style=" font-family:'Ubuntu'; font-weight:600;">cassandra.yaml</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Ubuntu';" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic;">cluster_name:</span> уникальное имя кластера</li>
<li style=" font-family:'Ubuntu';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic;">-seeds</span>: IP адреса всех порождающих узлов через запятую</li>
<li style=" font-family:'Ubuntu';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic;">listen_address:</span> IP адрес или имя хоста текущего узла по которому другие узлы будут подключатся к нему. По умолчанию localhost.</li>
<li style=" font-family:'Ubuntu';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic;">rpc_address:</span> адрес для соединения с клиентами. По умолчанию localhost.</li>
<li style=" font-family:'Ubuntu';" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic;">endpoint_snitch:</span> стратегия оповещения о топологии сети. Более подробно о всех типах можно прочитать <a href="http://docs.datastax.com/en/cassandra/3.x/cassandra/architecture/archSnitchesAbout.html?hl=snitches"><span style=" text-decoration: underline; color:#0000ff;">тут</span></a>.</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';">После всех настроек нужно возобновить работу сервера, рекомендуется поднимать сначала порождающие узлы, а затем остальные.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';">Проверить текущее состояние кластера и топологию сети можно командой:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ nodetool status</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';">Более подробно о том, как поднять несколько узлов в одном или нескольких датацентрах можно прочитать на </span><a href="http://docs.datastax.com/en/cassandra/3.0/cassandra/initialize/initTOC.html"><span style=" font-family:'Ubuntu'; text-decoration: underline; color:#0000ff;">этой</span></a><span style=" font-family:'Ubuntu';"> странице.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';">Для подключения аутентификации необходимо снова остановить сервер и сделать следующие изменения в файле cassandra.yaml</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">authenticator: PasswordAuthenticator</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';">При работе с cqlsh(см. далее) для первого входа необходимо использоваться пользователя cassandra и такой же пароль.</span></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu'; font-size:large; font-weight:600;"><br />Cassandra Query Language (CQL) и командная строка cqlsh</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';">CQL — SQL-подобный язык, адаптированный под архитектуру Cassandra. Через командную оболочку сqlsh мы можем отправлять команды CQL к Cassandra. Если вы предпочитаете работать с графическим редактором, то можете использовать </span><a href="https://docs.datastax.com/en/developer/devcenter/doc/devcenter/features.html"><span style=" font-family:'Ubuntu'; text-decoration: underline; color:#0000ff;">DataStax DevCenter</span></a><span style=" font-family:'Ubuntu';">.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';"><br />В качестве демонстрации основных команд CQL создадим небольшую таблицу на кластере с одним узлом (этот кластер поднимается автоматически при первом запуске). <br />Запускаем командную оболочку cqlsh:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">$ cqlsh</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';">Первое, что нам необходимо сделать, - это создать </span><span style=" font-family:'Ubuntu'; font-weight:600;">KEYSPACE</span><span style=" font-family:'Ubuntu';"> - своего рода аналог базы данных.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt; CREATE KEYSPACE IF NOT EXISTS msg WITH REPLICATION = { 'class' : 'SimpleStrategy', 'replication_factor' : 3 };</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';">Здесь </span><span style=" font-family:'Ubuntu'; font-style:italic;">SimpleStrategy</span><span style=" font-family:'Ubuntu';"> определяет используемый класс для стратегии репликации, а </span><span style=" font-family:'Ubuntu'; font-style:italic;">replication_factor</span><span style=" font-family:'Ubuntu';"> — количество репликаций. Более подробно о параметрах команды CREATE KEYSPACE и настройках репликации в Cassandra можно прочитать на </span><a href="https://docs.datastax.com/en/cql/3.1/cql/cql_reference/create_keyspace_r.html"><span style=" font-family:'Ubuntu'; text-decoration: underline; color:#0000ff;">этой</span></a><span style=" font-family:'Ubuntu';"> странице.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';">Далее переходим к работе с созданным пространством ключей:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt; use msg;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';">И создаем в нем таблицу </span><span style=" font-family:'Ubuntu'; font-style:italic;">pastes</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt; CREATE TABLE IF NOT EXISTS pastes (<br /> id timeuuid,<br /> title text,<br /> private boolean,<br /> body text,<br /> secret_key text,<br /> PRIMARY KEY (private, id)<br />) WITH default_time_to_live = 120 and CLUSTERING ORDER BY (id DESC);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';">Останавливаться на типах данных в CQL мы не будем, так как тут большая схожесть с SQL. Интересен здесь первичный ключ и все, что идет после конструкции WITH.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';">Первичный ключи состоит из распределительного и кластерного ключа. Распределительный ключ отвечает за распределение данных по узлам, а кластерный за группировку данных внутри узла. Ключи сами по себе могут быть составными.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';">Этап проектирования первичного ключа является самым важным, так как от этого напрямую зависит вся эффективность системы.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';">Конструкция </span><span style=" font-family:'Ubuntu'; font-style:italic;">time_to_live</span><span style=" font-family:'Ubuntu';"> позволяет задавать время жизни записи в секундах, а </span><span style=" font-family:'Ubuntu'; font-style:italic;">CLUSTERING ORDER</span><span style=" font-family:'Ubuntu';"> определяет сортировку данных.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';">Теперь добавим несколько записей в нашу таблицу</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt; INSERT INTO pastes (private, id, body, secret_key, title) VALUES (true,3c68b5b4-b1b1-11e6-80f5-76304dec7eb7,'hellow','asdr22sd','This is title');<br />&gt; INSERT INTO pastes (private, id, body, secret_key, title) VALUES (true,3c68b5b4-b1b1-11e6-80f5-76304dec7eb7,'hellow','asdr22sd','This is title');</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';">И выполним выборку данных:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt; SELECT private, id, body, secret_key, title FROM pastes</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image300992198.png" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';">В полученном результате редактор зеленым выделяет распределенный и кластерный ключ, все остальные поля — желтым.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';">Для фильтрации запросов используется аналогичная в SQL конструкция WHERE. Отличие заключается в том, что в данной конструкции необходимо сначала указывать ограничение по распределенному ключу, затем по кластерным и только потом — по обычным полям. Например, мы можем выполнить:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt; SELECT private, id, body, secret_key, title FROM pastes where private = true and id = 4368b5b4-b1b1-11e6-80f5-76304dec7eb7;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';">Но если мы будем фильтровать только по id, то запрос упадет с ошибкой:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt; SELECT private, id, body, secret_key, title FROM pastes where id = 4368b5b4-b1b1-11e6-80f5-76304dec7eb7;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image873255782.png" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';">Более подробную информация о всех командах CQL можно почерпнуть </span><a href="http://docs.datastax.com/en/cql/3.3/"><span style=" font-family:'Ubuntu'; text-decoration: underline; color:#0000ff;">здесь</span></a><span style=" font-family:'Ubuntu';">.</span></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu'; font-size:large; font-weight:600;">Заключение</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';">В данной статье мы рассмотрели как установить и настроить Cassandra, а также поверхностно познакомились с языком запросов CQL.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';"> </span></p></body></html>