<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#242327;"><a name="header"></a><a href="https://eax.me/"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:xx-large; font-weight:600; font-style:italic; color:#ffffff;">З</span></a><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:xx-large; font-weight:600; font-style:italic; color:#ffffff;">аписки программиста</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="header_desc"></a><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:16px; font-weight:600; font-style:italic; color:#bfbfbf;">Б</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:16px; font-weight:600; font-style:italic; color:#bfbfbf;">лог о программировании, а также электронике, радио, и всяком таком</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><a name="body"></a><span style=" font-family:'Trebuchet MS,Arial,Helvetica,sans-serif'; font-size:x-large; color:#000000;">Т</span><span style=" font-family:'Trebuchet MS,Arial,Helvetica,sans-serif'; font-size:x-large; color:#000000;">уториал по контейнеризации при помощи LXC</span></p>
<p style=" margin-top:4px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:12px; color:#444444;">17 февраля 2016</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:20px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Пришло время научиться работать с Linux Containers, более известными под названием LXC. Далее мы будем рассматривать LXC в контексте Debian и Ubuntu, но написанное во многом будет применимо и для других дистрибутивов Linux. Мы коснемся не только основ использования LXC, но и узнаем, как настроить bridged сеть, ограничить количество ресурсов, используемых контейнером, и даже осилим unprivileged containers.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:large; font-weight:600; color:#222222;">Коротко о главном</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">LXC — технология </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; font-style:italic; color:#222222;">контейнерной виртуализации</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">, как и OpenVZ. Накладные расходы на создание контейнеров очень невелики, и ничто не мешает нам запускать их сотнями или тысячами. Что невозможно при использовании честной и полноценной виртуализации, такой, как </span><a href="https://eax.me/kvm/"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; text-decoration: underline; color:#666666;">KVM</span></a><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">. С другой стороны, запустить в контейнере ОС, отличную от Linux, мы не можем. На самом деле, не совсем корректно называть LXC отдельной технологией. Все работает сразу на нескольких фичах ядра Linux. Как минимум, это cgroups и namespaces.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://en.wikipedia.org/wiki/Cgroups"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; text-decoration: underline; color:#666666;">Control Groups</span></a><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">, они же cgroups, позволяют организовывать процессы в группы и для каждой группы задавать лимиты. Например, лимиты на использование CPU, объем используемой памяти и дисковый ввод-вывод.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://en.wikipedia.org/wiki/Cgroups#Namespace_isolation"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; text-decoration: underline; color:#666666;">Namespaces</span></a><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;"> бывают разные — PID namespace, IPC namespace, UTS namespace, user namespace, mount namespace, network namespace. Неймспейсы изолируют друг от другая процессы таким образом, что процессы в одной группе не могут видеть ресурсы другой группы. Например, PID namespace предоставляет уникальные идентификаторы процессов в рамках группы. Внутри одной группы может быть процесс с pid’ом 1 и внутри второй группы тоже может быть процесс с pid’ом 1, хотя это два совершенно разных процесса, которые друг о другие ничего не знают. Притом, все процессы все также имеют уникальные id в рамках ОС. Просто, если смотреть на процессы из группы, то эти id отображаются в другие.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">В отличие от </span><a href="https://eax.me/docker/"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; text-decoration: underline; color:#666666;">Docker</span></a><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">, который заточен на создание PaaS, в LXC нет никаких слоеных неизменяемых файловых систем. Контейнеры очень похожи на VDS’ы, как и в OpenVZ. Но в отличие от OpenVZ, в LXC далеко не все есть из коробки. Как мы скоро убедимся, для ограничения места на диске, используемого контейнером, приходится прибегать к дополнительным ухищрениям. Повторюсь, связано это с тем, что LXC не совсем одна полноценная технология. С другой стороны, LXC не нуждается в пропатченном ядре. Все необходимое уже и так есть в ванильном ядре Linux. Как следствие, LXC превосходно работает на самой обычной Ubuntu, чем OpenVZ похвастаться не может.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; font-style:italic; color:#222222;">Примечание:</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;"> Кстати, в заметке </span><a href="https://eax.me/vagrant/"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; text-decoration: underline; color:#666666;">Начало работы с Vagrant и зачем он вообще нужен</span></a><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;"> рассказывается, как работать с LXC через Vagrant. Использование LXC через Vagrant кому-то может показаться удобнее, чем работа с LXC напрямую.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:large; font-weight:600; color:#222222;">Установка</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Как было отмечено выше, все необходимое уже есть в ядре. Тем не менее, для хождения в ядро понадобятся некоторые дополнительные утилиты. Также не повредит обновить до последней версии кое-какие, казалось бы, не особо связанные с LXC пакеты.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Итак:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">apt-get update</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">apt-get install</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> lxc lxc-templates systemd-services cgroup-bin \<br />  bridge-utils debootstrap</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Очень важно реально сделать update, чтобы поставились наиболее свежие версии указанных пакетов. И, не поверите, но реально лучше сразу сделать </span><span style=" font-family:'Courier New,courier'; font-size:13px; color:#000000; background-color:#f1f1f1;">reboot</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">. Иначе, работая с LXC, вы в какой-то момент можете получить странную ошибку вроде такой:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000; background-color:#f1f1f1;">call to cgmanager_create_sync failed: invalid request</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">… и будете потом через Google выяснять, </span><a href="https://github.com/lxc/lxc/issues/206"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; text-decoration: underline; color:#666666;">что же пошло не так</span></a><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Свои данные LXC хранит в следующих местах:</span></p>
<ul type="square" style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:10px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:15px;">/var/lib/lxc — тут лежат контейнеры, их настройки, ФС и так далее;</span></li>
<li style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:10px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:15px;">/etc/lxc — прочие настройки;</span></li>
<li style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:10px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:15px;">/etc/default/lxc-net — тут можно поменять настройки сети;</span></li>
<li style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:10px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:15px;">/var/cache/lxc — кэш шаблонов;</span></li>
<li style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:10px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:15px;">/var/lib/lxcsnaps — сюда пишутся снапшоты;</span></li>
<li style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;" style=" margin-top:0px; margin-bottom:10px; margin-left:30px; margin-right:10px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:15px;">/var/log/lxc — логи;</span></li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Теперь рассмотрим команды для управления контейнерами.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:large; font-weight:600; color:#222222;">Основные команды</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Создание контейнера с именем test-container из шаблона Ubuntu:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> lxc-create -n test-container -t ubuntu</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Увидим что-то вроде:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000; background-color:#f1f1f1;">##</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br /># The default user is 'ubuntu' with password 'ubuntu'!<br /># Use the 'sudo' command to run tasks as root in the container.<br />##</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Посмотреть список доступных шаблонов можно так:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">ls</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> /usr/share/lxc/templates/</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Список скачанных шаблонов:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">ls</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> /var/cache/lxc/</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Удалить шаблон можно просто удалив соответствующий ему каталог.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Запуск контейнера в бэкграунде:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> lxc-start -d -n test-container</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Для отладки — запуск с логированием:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> lxc-start -l debug -o </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#0080a0;">1</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;">.log -d -n test-container</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Список контейнеров:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> lxc-ls -f</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Подробная информация о контейнере:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> lxc-info -n test-container</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Заходим в контейнер:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> lxc-console -n test-container</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">В нашем случае логин и пароль — ubuntu. Для выхода из контейнера жмем Ctr+A, затем Q.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Остановка контейнера:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> lxc-stop -n test-container</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Создание клона контейнера (test-container должен быть остановлен):</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> lxc-clone -o test-container -n test-container-clone</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Удалить контейнер:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> lxc-destroy -n test-container</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Заморозить/разморозить контейнер:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> lxc-freeze -n test-container<br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> lxc-unfreeze -n test-container</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Создать снапшот (контейнер должен быть остановлен):</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> lxc-snapshot -n test-container</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Список снапщотов:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> lxc-snapshot -n test-container -L</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Восстановление из снапшота:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> lxc-snapshot -n test-container -r snap0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Если нужно пошарить каталог, проще всего сделать это при помощи sshfs:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000; background-color:#f1f1f1;">sshfs ubuntu</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;">@10.110.0.10: ./shared-dir</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Пока ничего сложного.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:large; font-weight:600; color:#222222;">Автозапуск</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Чтобы контейнер запускался при старте системы, в конфиг контейнера (в нашем случае это файл /var/lib/lxc/test-container/config) дописываем:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000; background-color:#f1f1f1;">lxc.start.auto  =  1 # enabled</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br />lxc.start.delay = 15 # delay in seconds<br />lxc.start.order = 50 # higher value means starts earlier</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Если все было сделано верно, команда </span><span style=" font-family:'Courier New,courier'; font-size:13px; color:#2060a0; background-color:#f1f1f1;">sudo</span><span style=" font-family:'Courier New,courier'; font-size:13px; color:#000000; background-color:#f1f1f1;"> lxc-ls -f</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;"> покажет YES в колонке autostart.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:large; font-weight:600; color:#222222;">Ограничение на использование ресурсов</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Попробуем ограничить количество памяти, которое может отъедать контейнер.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Останавливаем контейнер:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> lxc-stop -n test-container</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Затем правим /var/lib/lxc/test-container/config:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000; background-color:#f1f1f1;">lxc.cgroup.memory.limit_in_bytes = 256M</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Говорим:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> lxc-start -d -n test-container -l debug -o test.log<br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">cat</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> test.log  | </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">grep</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> -i memory</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Должны увидеть что-то вроде:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000; background-color:#f1f1f1;">lxc-start 1449237148.829 DEBUG lxc_cgmanager - cgmanager.c:</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br />cgm_setup_limits:1385 - cgroup 'memory.limit_in_bytes' set to '256M'</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Проверяем, что настройки применились:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> lxc-cgroup -n test-container memory.limit_in_bytes</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Можно менять лимиты на лету, но они потеряются с рестартом:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> lxc-cgroup -n test-container memory.limit_in_bytes 100M</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Также можно следить, сколько ресурвов потребляет контейнер прямо сейчас:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">cat</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> /sys/fs/cgroup/memory/lxc/test-container/memory.usage_in_bytes</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Вот еще интересные параметры:</span></p>
<ul type="square" style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:10px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:15px;">cpu.shares — сколько единиц процессорного времени отдавать контейнеру, если у одного 2000 единиц, а у второго 1000, второй получит в два раза меньше времени;</span></li>
<li style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:10px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:15px;">cpuset.cpus — какие ядра может использовать контейнер, номера начиная с нуля, например </span><span style=" font-family:'Courier New,courier'; font-size:13px; color:#000000; background-color:#f1f1f1;">0,1</span><span style=" font-size:15px;"> или </span><span style=" font-family:'Courier New,courier'; font-size:13px; color:#000000; background-color:#f1f1f1;">0-3</span><span style=" font-size:15px;">;</span></li>
<li style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:10px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:15px;">memory.memsw.limit_in_bytes — ограничение на память и своп в сумме, если своп вообще есть;</span></li>
<li style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;" style=" margin-top:0px; margin-bottom:10px; margin-left:30px; margin-right:10px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:15px;">blkio.weight — как cpu.shared, только про дисковый ввод-вывод;</span></li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://serverfault.com/a/471276/318752"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; text-decoration: underline; color:#666666;">Тут</span></a><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;"> больше параметров — есть, к примеру, про сеть.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:large; font-weight:600; color:#222222;">Ограничение на использование дискового пространства</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Эту задачу можно решить несколькими способами. Например, многие советуют использовать LVM. И хотя LVM, бесспорно, крутая штука, использовать его для решения такой простой задачи мне лично кажется оверкилом. Предлагаю пойти более простым путем.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Допустим, мы хотим создать контейнер с именем new-container, который будет занимать на диске не более 10 Гб.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> truncate -s 10G /var/lib/lxc/new-container.img<br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> mkfs.ext4 -F /var/lib/lxc/new-container.img<br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">mkdir</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> /var/lib/lxc/new-container<br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">mount</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> -t ext4 -o loop /var/lib/lxc/new-container.img \<br />  /var/lib/lxc/new-container</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Теперь создаем контейнер, как обычно:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> lxc-create -t ubuntu -n new-container</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Заходим внутрь контейнера, и через </span><span style=" font-family:'Courier New,courier'; font-size:13px; color:#000000; background-color:#f1f1f1;">df</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;"> видим, что отъесть от диска он может только 10 Гб.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Чтобы не приходилось каждый раз монтировать раздел руками, в /etc/fstab дописываем:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000; background-color:#f1f1f1;">/var/lib/lxc/new-container.img /var/lib/lxc/new-container ext4 loop 0 0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Вы можете заметить, что количество loop-устройств в системе ограничено. В Ubuntu, например, их по умолчанию только 8. Если попытаться создать много контейнеров описанным выше образом, вы получите ошибку:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000; background-color:#f1f1f1;">mount: could not find any free loop device</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Эту проблему можно решить следующим скриптом:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; font-style:italic; color:#406040;">#!/bin/sh</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br /><br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">for</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> i </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">in</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> $(</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">seq</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#0080a0;">0</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#0080a0;">64</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;">); </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">do</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br />  [ -b /dev/loop</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#a08000;">$i</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> ] || (</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">mknod</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> -m </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#0080a0;">660</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> /dev/loop</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#a08000;">$i</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> b </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#0080a0;">7</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#a08000;">$i</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> &amp;&amp; \<br />     </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">chown</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> root:disk /dev/loop</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#a08000;">$i</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;">)<br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">done</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Чтобы loop-устройства создавались при загрузке системы, создаем файл /etc/init.d/more-loop-devices следующего содержания:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; font-style:italic; color:#406040;">#!/bin/bash</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br /><br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; font-style:italic; color:#406040;">### BEGIN INIT INFO</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; font-style:italic; color:#406040;"># Provides:          more-loop-devices</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; font-style:italic; color:#406040;"># Required-Start:    $syslog</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; font-style:italic; color:#406040;"># Required-Stop:     $syslog</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; font-style:italic; color:#406040;"># Default-Start:     2 3 4 5</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; font-style:italic; color:#406040;"># Default-Stop:      0 1 6</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; font-style:italic; color:#406040;"># Short-Description: More Loop Devices</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; font-style:italic; color:#406040;"># Description:       More Loop Devices</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; font-style:italic; color:#406040;">### END INIT INFO</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br /><br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#008080;">PATH</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;">=/sbin:/usr/sbin:/bin:/usr/bin<br /><br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; font-style:italic; color:#406040;"># Load the VERBOSE setting and other rcS variables</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br />. /lib/init/vars.sh<br />. /lib/lsb/init-functions<br /><br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">case</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#c03030;">&quot;$1&quot;</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">in</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br />  start)<br />    </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">for</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> i </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">in</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> $(</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">seq</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#0080a0;">0</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#0080a0;">64</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;">); </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">do</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br />      [ -b /dev/loop</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#a08000;">$i</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> ] || (</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">mknod</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> -m </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#0080a0;">660</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> /dev/loop</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#a08000;">$i</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> b </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#0080a0;">7</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#a08000;">$i</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> &amp;&amp; \<br />         </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">chown</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> root:disk /dev/loop</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#a08000;">$i</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;">)<br />    </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">done</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br />    ;;<br />  *)<br />    </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#008080;">echo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#c03030;">&quot;Usage: more-loop-devices start&quot;</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> &gt;&amp;</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#0080a0;">2</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br />    </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#008080;">exit</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#0080a0;">1</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br />    ;;<br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">esac</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Говорим:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">chmod</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> a+x /etc/init.d/more-loop-devices<br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> update-rc.d more-loop-devices defaults</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">В этот же скрипт при необхожимости можно прописать и монтирование. Честно говоря, мне пока не нужно было так много контейнеров. Поэтому я не проверял, действительно ли в этом есть необходимость, или же достаточно записи в fstab.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:large; font-weight:600; color:#222222;">Настройка bridged сети</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Ранее в заметке </span><a href="https://eax.me/openvz/"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; text-decoration: underline; color:#666666;">Контейнерная виртуализация при помощи OpenVZ</span></a><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;"> мы научились настраивать bridged сеть под CentOS. Настало время узнать, как то же самое делается в Debian и Ubuntu.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Правим /etc/network/interfaces — часть про eth0 убираем, вместо нее пишем:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000; background-color:#f1f1f1;">auto eth0</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br />iface eth0 inet manual</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Далее, если у вас DHCP:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000; background-color:#f1f1f1;">auto br0</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br />iface br0 inet dhcp<br />        bridge_ports eth0<br />        bridge_stp off<br />        bridge_fd 0<br />        bridge_maxwait 0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Если же у вас используются статические адреса:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000; background-color:#f1f1f1;">auto br0</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br />iface br0 inet static<br />        address 192.168.0.123<br />        network 192.168.0.0<br />        netmask 255.255.255.0<br />        broadcast 192.168.0.255<br />        gateway 192.168.0.1<br />        bridge_ports eth0<br />        bridge_stp off<br />        bridge_fd 0<br />        bridge_maxwait 0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Перезагружаемся.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Если все было сделано правильно, в ifconfig’е увидим интерфейс br0.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Далее останавливаем контейнер и правим /var/lib/lxc/(container)/config:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000; background-color:#f1f1f1;">lxc.network.link = br0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Если хотим присвоить контейнеру статический IP, также дописываем:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000; background-color:#f1f1f1;">lxc.network.ipv4.gateway = 192.168.0.1</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br />lxc.network.hwaddr = 00:16:3e:6b:c7:5b<br />lxc.network.ipv4 = 192.168.0.124/24</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Запускаем контейнер. Если все было сделано правильно, в контейнер можно будет ходить из локалки и </span><span style=" font-family:'Courier New,courier'; font-size:13px; color:#000000; background-color:#f1f1f1;">sudo lxc-ls -f</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;"> покажет у него соответствующий IP.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:large; font-weight:600; color:#222222;">Резервное копирование и восстановление</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Как уже отмечалось, все лежит в /var/lib/lxc. Поэтому просто нужно аккуратно заархивировать все данные оттуда. Тут каждый использует, что ему больше нравится. Для примера рассмотрим решение задачи при помощи tar.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Останавливаем контейнер, под рутом делаем:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#008080;">cd</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> /var/lib/lxc/test-container<br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">tar</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> -cvzf backup.tgz ./</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Резервная копия готова! Для восстановления же говорим:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">mkdir</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> -p /var/lib/lxc/test-container<br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#008080;">cd</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> /var/lib/lxc/test-container<br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">scp</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> example.ru:path/to/backup.tgz ./<br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">tar</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> -xvzf backup.tgz<br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">rm</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> backup.tgz</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Теперь контейнер виден в </span><span style=" font-family:'Courier New,courier'; font-size:13px; color:#000000; background-color:#f1f1f1;">lxc-ls</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;"> и может быть запущен через </span><span style=" font-family:'Courier New,courier'; font-size:13px; color:#000000; background-color:#f1f1f1;">lxc-start</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Если описанным образом вы создаете копию контейнера (вам чем-то не подошел lxc-clone) или при восстановлении контейнера решили его переименовать, придется чуть-чуть подправить файл config. Там просто нужно поменять пути и изменить имя контейнера, плюс я бы сменил на всякий случай MAC.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">В общем-то, это все. Ну разве что у tar’а еще флаг </span><span style=" font-family:'Courier New,courier'; font-size:13px; color:#000000; background-color:#f1f1f1;">--numeric-owner</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;"> рекомендуют использовать.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Если же вы ограничиваете место на диске, которое может занимать контейнер, как это было описано выше, то резервное копирование и восстановление делается еще проще.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:large; font-weight:600; color:#222222;">Непривилегированные контейнеры</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Оказывается, что контейнерами можно управлать и под самыми обыкновенными пользователями, не под рутом. Как минимум, это намного безопаснее.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">При этом каталоги немного меняются:</span></p>
<ul type="square" style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:10px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:15px;">~/.local/share/lxc — тут лежат контейнеры, их настройки, ФС и так далее;</span></li>
<li style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:10px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:15px;">~/.config/lxc — прочие настройки;</span></li>
<li style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:10px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:15px;">~/.cache/lxc — кэш шаблонов;</span></li>
<li style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;" style=" margin-top:0px; margin-bottom:10px; margin-left:30px; margin-right:10px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:15px;">~/.local/share/lxcsnaps — сюда пишутся снапшоты;</span></li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Первым делом говорим:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">usermod</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> --add-subuids </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#0080a0;">100000</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;">-</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#0080a0;">165536</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> eax<br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">usermod</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> --add-subgids </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#0080a0;">100000</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;">-</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#0080a0;">165536</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> eax<br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">sudo</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">chmod</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> +x /home/eax</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">… где eax — имя вашего пользователя в системе.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Только что мы выделили 65536 uid’ов и gid’ов пользователю eax. В контейнере будут использоваться айдишники от 0 до 65535, которые будут отображаться в айдишники от 100000 до 165535 в хост-системе.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Далее:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">mkdir</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> -p ~/.config/lxc</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Копируем /etc/lxc/default.conf в ~/.config/lxc/default.conf и дописываем в конце:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000; background-color:#f1f1f1;">lxc.id_map = u 0 100000 65536</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br />lxc.id_map = g 0 100000 65536</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">В файл /etc/lxc/lxc-usernet пишем:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000; background-color:#f1f1f1;"># USERNAME TYPE BRIDGE COUNT</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br />eax        veth lxcbr0 100</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Создаем контейнер (как видите, без sudo):</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000; background-color:#f1f1f1;">lxc-create</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> -t download -n test-container -- -d ubuntu \<br />  -r trusty -a amd64</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Заметьте, как это работает. Мы указали тип контейнера download, которому передали в качестве аргумента название дистрибутива, релиза и архитектуры CPU. Все эти три параметра обязательны при создании непривилегированных контейнеров.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Теперь запускаем контейнер, как обычно:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000; background-color:#f1f1f1;">lxc-start</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> -d -n test-container</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">В случае возникновения проблем:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000; background-color:#f1f1f1;">lxc-start</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> -d -n test-container --logfile t.log --logpriority debug</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; font-style:italic; color:#222222;">Дополнение:</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;"> Чтобы непривилегированные контейнеры заработали, может потребоваться перезагрузка. Если вы используете encfs, команды sudo и ping могут не работать. Это баг. </span><a href="https://bugs.launchpad.net/ubuntu/+source/lxc/+bug/1389305/comments/7"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; text-decoration: underline; color:#666666;">Здесь</span></a><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;"> рассказывается, как примерно можно его обойти. Идея в том, чтобы при помощи симлинков положить контейнеры и конфиги за пределы encfs.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Шаблоны непривилегированных контейнеров немного отличаются от тех, что мы использовали раньше. В частности, никакого SSH по умолчанию в них не крутится. Но это легко исправить. Заходим в контейнер под рутом при помощи lxc-attach:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000; background-color:#f1f1f1;">lxc-attach</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> -n test-container</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">… и говорим:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f1f1f1;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">apt-get install</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> </span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">ssh</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"><br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#2060a0;">passwd</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:13px; color:#000000;"> ubuntu</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Ну вот, а в остальном все как обычно.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:large; font-weight:600; color:#222222;">Заключение</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Не могу не отметить ряд косяков в LXC:</span></p>
<ul type="square" style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:10px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:15px;">У LXC довольно высокий порог вхождения и вообще все как-то неудобно. Я просто хочу, чтобы контейнер не отжирал больше 1 Гб памяти. Я не хочу ничего знать ни о каких cgroups и читать документацию по ним на сайте RedHat! Про то, как приходится плясать для банального ограничения места на диске, я вообще молчу. OpenVZ в этом плане намного, НАМНОГО лучше;</span></li>
<li style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:10px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:15px;">В LXC все очень сыро и плохо документированно. Я собирал представленную в этом посте информацию по крупицам, наверное, около месяца, попутно гугля по поводу багов, на которые я натыкался в процессе. Вам, уважаемые читатели, в этом плане будет намного проще;</span></li>
<li style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:10px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:15px;">На мой взгляд, интерфейс продуман плохо. Например, первое время я постоянно забывал флаг </span><span style=" font-family:'Courier New,courier'; font-size:13px; color:#000000; background-color:#f1f1f1;">-d</span><span style=" font-size:15px;"> у </span><span style=" font-family:'Courier New,courier'; font-size:13px; color:#000000; background-color:#f1f1f1;">lxc-start</span><span style=" font-size:15px;">. Правда, потом я уже как-то то ли привык, то ли запомнил. Да и если контейнеры прописаны на автозагрузку, такой проблемы нет;</span></li>
<li style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:10px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:15px;">Внутри контейнера мы видим занятую и свободную память хост-системы, а не контейнера. В результате, из контейнера не ясно, кто же отожрал всю память. К тому же, некоторые программы могут работать из-за этого некорректно;</span></li>
<li style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:10px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:15px;">Неизбежны накладные расходы в случае ограничения используемого места на диске;</span></li>
<li style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;" style=" margin-top:0px; margin-bottom:10px; margin-left:30px; margin-right:10px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:15px;">Плохие сообщения об ошибках. Шаг влево, шаг вправо — и тут же получаем что-то в стиле «No such file or directory — execlp»;</span></li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Тем не менее, если вы хотите запихнуть что-то в контейнер под Ubuntu, и при этом вы не пишите PaaS’ов, LXC может быть для вас неплохим вариантом. Особенно теперь, когда вы знаете о большинстве подвобных граблей этой технологии.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">Больше полезной информации вы найдете на сайте </span><a href="https://linuxcontainers.org/"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; text-decoration: underline; color:#666666;">linuxcontainers.org</span></a><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">, а также в списке рассылки </span><a href="https://lists.linuxcontainers.org/listinfo/lxc-users"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; text-decoration: underline; color:#666666;">lxc-users@</span></a><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">. Если вас интересует, как запускать GUI-приложения под LXC, обратите внимание на заметку </span><a href="https://eax.me/docker-gui-apps/"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; text-decoration: underline; color:#666666;">Осилил запуск GUI-приложений в Docker</span></a><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">. Она без единого изменения применима и к LXC.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; font-style:italic; color:#222222;">Дополнение:</span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;"> Также вас могут заинтересовать статьи </span><a href="https://eax.me/proxmox/"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; text-decoration: underline; color:#666666;">Мой первый опыт использования Proxmox VE</span></a><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;"> и </span><a href="https://eax.me/vboxmanage/"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; text-decoration: underline; color:#666666;">Управление VirtualBox из консоли с помощью vboxmanage</span></a><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#222222;">.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; font-style:italic; color:#222222;">Метки: </span><a href="https://eax.me/tag/linux/"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; font-style:italic; text-decoration: underline; color:#666666;">Linux</span></a><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; font-style:italic; color:#222222;">, </span><a href="https://eax.me/tag/virtualization/"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; font-style:italic; text-decoration: underline; color:#666666;">Виртуализация</span></a><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; font-style:italic; color:#222222;">, </span><a href="https://eax.me/tag/networks/"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; font-style:italic; text-decoration: underline; color:#666666;">Сети</span></a><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; font-style:italic; color:#222222;">.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comments"></a><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#ff5900;"><br /></span><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#ff5900;">Вы можете прислать свой комментарий мне на почту, или воспользоваться комментариями в </span><a href="https://eax.me/telegram/"><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; text-decoration: underline; color:#ff5900;">Telegram-группе</span></a><span style=" font-family:'Arial,Helvetica,sans-serif'; font-size:15px; color:#ff5900;">.</span></p></body></html>