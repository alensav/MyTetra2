<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:x-large; font-weight:600;">Установки и настройка OpenVPN в Ubuntu Linux за 5 минут</span> </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">4 марта 2015 </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Постоянные читатели этого блога, скорее всего, уже пару-тройку раз в своей жизни настраивали OpenVPN. Но думается, что новичкам данная заметка будет интересна и полезна. Из нее вы узнаете, как за пять минут поднять собственный VPN сервер, а также зачем он, собственно, нужен. Ну хорошо, учитывая время на регистрацию в каком-нибудь <a href="https://eax.me/aws-intro/"><span style=" text-decoration: underline; color:#0000ff;">Amazon’е</span></a>, DigitalOcean, Vscale.io или FastVDS и оплату VDS, пожалуй, потребуется не пять минут, а «целых» пятнадцать. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Итак, зачем же кому-то ходить в сеть через VPN? На то есть целый ряд причин. Например, чтобы ваши пароли, передаваемые по HTTP, не утекли, когда вы сидите с открытых WiFi точек неизвестного происхождения. Да и вообще, даже вашему обычному провайдеру не обязательно знать, на какие сайты вы ходите. Еще — чтобы <a href="https://eax.me/scala-geoip/"><span style=" text-decoration: underline; color:#0000ff;">не палить свой IP</span></a> в <a href="https://eax.me/irc-descr/"><span style=" text-decoration: underline; color:#0000ff;">IRC сетях</span></a> и прочих сервисах, с которыми вы работаете. Им знать ваше местоположение тоже совсем ни к чему. Также вам может захотеться попробовать какой-нибудь новый сервис, который пока что недоступен для пользователей с российским IP. Кроме того, трафик между вами и VPN сервером не только шифруется, но и сжимается, что нередко может создать ощущение более быстрого интернета. Еще OpenVPN может быть полезен в ряде других случаев, например, для доступа сотрудников ко внутренним ресурсам компании, когда они не в офисе.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Почему VPN, а не какие-нибудь прокси или пробрасывание портов через SSH, надеюсь, тоже понятно. VPN достаточно настроить один раз и сразу весь трафик всех приложений пойдет через VPN cервер, в сжатом и зашифрованном виде.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Чтобы поднять свой VPN, вам потребуется собственный сервер с Ubuntu Linux (или любым другим Linux/*BSD, но тогда вам будет довольно сложно следовать инструкциям данной заметки), а также права root’а на нем. Если сервер у вас уже есть, хорошо. Если нет, то не расстраивайтесь. В наши дни купить подходящий VDS/VPS можно за смешные 5$ в месяц или даже меньше. Компаний, предлагающих соответствующие услуги — десятки, некоторые были названы в начале заметки. Лично я рекомендую присмотреться к <a href="https://eax.me/digitalocean/"><span style=" text-decoration: underline; color:#0000ff;">DigitalOcean</span></a>. Но не поленитесь изучить вопрос самостоятельно, так как к моменту прочтения вами этих строк ситуация на рынке VDS может измениться.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Заходим на сервер, становимся root’ом, говорим:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">apt-get update<br />apt-get install openvpn</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Раньше в OpenVPN входила утилита под названием easy-rsa, предназначенная для генерации ключей и сертификатов. Начиная с версии 2.3 эту утилиту из пакета выпилили, поэтому придется скачать и собрать ее самостоятельно:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">cd /tmp<br />wget https://github.com/OpenVPN/easy-rsa/archive/master.zip<br />apt-get install unzip<br />unzip master.zip<br />cd easy-rsa-master<br />./build/build-dist.sh<br />tar xvzf ./EasyRSA-git-development.tgz<br />cd EasyRSA-git-development</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Генерируем все необходимые ключи и сертификаты. Приготовьтесь вводить для них пароли. Так как мы настраиваем персональный VPN сервер, то, видимо, можно использовать один-единственный пароль, но подлиннее:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">./easyrsa init-pki<br />./easyrsa build-ca<br />./easyrsa build-server-full server<br />./easyrsa build-client-full client1<br />./easyrsa gen-dh</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Выполнение последней команды может занять несколько минут.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Переносим полученные ключи и сертификаты в каталог /etc/openvpn/:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">mv ./pki/dh.pem /etc/openvpn/dh.pem<br />mv ./pki/private/client1.key /etc/openvpn/<br />mv ./pki/private/server.key /etc/openvpn/<br />mv ./pki/ca.crt /etc/openvpn/<br />mv ./pki/issued/client1.crt /etc/openvpn/<br />mv ./pki/issued/server.crt /etc/openvpn/</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В том же каталоге создаем файл server.conf:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">mode server<br />dev tun<br />server 10.128.0.0 255.255.255.0<br />push &quot;redirect-gateway def1&quot;<br /># важно! иначе будем ходить в DNS провайдера<br />push &quot;dhcp-option DNS 8.8.8.8&quot;<br />tls-server<br />ca ca.crt<br />cert server.crt<br />key server.key<br />dh dh.pem<br />proto tcp-server<br />port 1194<br /># клиенты видят друг друга<br />client-to-client<br />comp-lzo<br />keepalive 10 120<br />verb 4<br />cipher AES-256-CBC<br />user nobody<br />group nogroup<br />max-clients 10</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Попробуем запустить OpenVPN. При запуске от вас будет требоваться ввести пароль. Соответственно, после ребута поднимать OpenVPN придется руками. Но поскольку мы настраиваем персональный VPN, вряд ли это представляет собой бОльшую проблему, чем ключи, лежащие в открытом виде, или еще хуже — сохраненные пароли. Запускаем:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">service openvpn start</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Проверяем:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">netstat -tuwpan</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Сервер должен слушать порт 1194. Если это не так, курим /var/log/syslog.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Теперь что касается клиентской стороны. Нам понадобятся файлы client1.crt, client1.key и ca.crt:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">mkdir vpn<br />cd vpn<br />scp vpn-server:/etc/openvpn/client1.crt ./<br />scp vpn-server:/etc/openvpn/client1.key ./<br />scp vpn-server:/etc/openvpn/ca.crt ./</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Создадим файл client.conf:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">client<br />proto tcp<br />dev tun<br /># !!! замените на настоящий ip адрес сервера<br />remote 123.45.67.89 1194<br /><br /># следующие две строчки актуальны только для *nix систем<br /># на практике они не очень удобны, так как OpenVPN не сможет<br /># нормально все за собой почистить по завершению работы<br /><br /># user nobody<br /># group nogroup<br /><br />persist-key<br />persist-tun<br />ca ca.crt<br />cert client1.crt<br />key client1.key<br />cipher AES-256-CBC<br />comp-lzo<br />verb 3</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Подрубаемся к серверу, внимательно читаем логи:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">sudo openvpn --config client.conf</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В соседнем терминале говорим:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">ping 10.128.0.1<br />traceroute mail.ru</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если все было сделано правильно, вы обнаружите, что пинги успешно доходят до 10.128.0.1 (первая команда), но пакеты через него никуда не проходят (вторая команда). Это потому что мы забыли настроить на сервере NAT. Что мне лично кажется странным. Я смутно припоминаю, что когда в свое время я поднимал OpenVPN на <a href="https://eax.me/goodbye-freebsd/"><span style=" text-decoration: underline; color:#0000ff;">FreeBSD</span></a>, подобного шага не требовалось. Впрочем, я могу и ошибаться.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">На сервере открываем файл /etc/sysctl.conf и раскомментируем в нем строчку:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">net.ipv4.ip_forward=1</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Чтобы не пришлось перезагружаться, говорим:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">echo 1 &gt;&gt; /proc/sys/net/ipv4/conf/all/forwarding</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Затем:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">iptables -A FORWARD -s 10.128.0.0/24 -j ACCEPT<br />iptables -A FORWARD -d 10.128.0.0/24 -m state \<br />  --state ESTABLISHED,RELATED -j ACCEPT<br />iptables -t nat -A POSTROUTING -s 10.128.0.0/24 \<br />  -j SNAT --to-source 123.45.67.89</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">… где 123.45.67.89 — это IP сервера. Переподключаемся клиентом, попробуем зайти на какие-нибудь <a href="http://2ip.ru"><span style=" text-decoration: underline; color:#0000ff;">2ip.ru</span></a> или <a href="https://eax.me/ip/"><span style=" text-decoration: underline; color:#0000ff;">eax.me/ip</span></a> — теперь все должно работать. Если это не так, курим логи. Если все ОК, сохраняем правила фаервола на сервере:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">iptables-save &gt; /etc/iptables.rules</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">… и проверяем, что в файле /etc/network/interfaces есть строчка:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">pre-up iptables-restore &lt; /etc/iptables.rules</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если на сервере ранее уже <a href="https://eax.me/iptables/"><span style=" text-decoration: underline; color:#0000ff;">настраивался фаервол</span></a>, может оказаться, что правила хранятся в файле с именем, отличным от /etc/iptables.rules.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Можно сказать <span style=" font-family:'Courier New,courier';">reboot</span> и проверить, что настройки держатся после перезагрузки сервера:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">cat /proc/sys/net/ipv4/conf/all/forwarding<br />iptables -L -n</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Сервер OpenVPN, разумеется, придется перезапустить руками.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Осталось сделать последний штрих на клиенте. Дело в том, что (1) запускать openvpn в отдельном терминале и следить, не упал ли он там, неудобно. Кроме того, (2) если на клиенте сказать:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">nm-tool | grep DNS<br />sudo iptables -A OUTPUT -d 192.168.0.1 -j DROP<br /># ^ для удаления правила введите ту же команду с -D вместо -A</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">… где 192.168.0.1 — DNS вашего провайдера (выводится утилитой nm-tool), вы обнаружите, что резолвинг доменов сломался, а следовательно клиент все еще использует DNS провайдера. Можно убить двух зайцев, сказав:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">sudo apt-get install network-manager-openvpn-gnome</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">… и настроив VPN через NetworkManager (иконку сети в правом верхнем углу <a href="https://eax.me/unity/"><span style=" text-decoration: underline; color:#0000ff;">Unity</span></a>). Делается это несложно, фактически нужно повторить текстовый конфиг клиента при помощи галочек и полей ввода. Понять, какая галочка какой строчке в конфиге соответствует, очень легко. Главное — не полениться залезть во всякие продвинутые свойства сети и прочие разделы настроек. Если же вы где-то ошибетесь, проблему можно с легкостью диагностировать при помощи файла /var/log/syslog.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Несмотря на то, что заметка получилась довольно длинной, настройка OpenVPN действительно занимает всего лишь несколько минут. Безопасного и быстрого вам веб-серфинга! А также, как всегда, я буду искренне рад вашим вопросам и дополнениям.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic;">Дополнение:</span> Я столкнулся с такой проблемой, что OpenVPN не переподключался к серверу после выхода ноутбука из спящего режима. Исправить ситуацию помогла команда <span style=" font-family:'Courier New,courier';">sudo pkill --signal SIGHUP --exact openvpn</span>, выполняемая сразу после выходя из спящего режима. Для этого соответствующая команда <a href="https://github.com/afiskon/archlinux-on-desktop/blob/master/home/eax/bin/zzz"><span style=" text-decoration: underline; color:#0000ff;">была дописана в скрипт</span></a>, который я использую для <span style=" font-style:italic;">входа</span> в спящий режим, откуда она вызывается с небольшой задержкой. Чтобы это работало, у пользователя должно быть право говорить sudo без пароля. Кроме того, в конфиге сервера OpenVPN мне пришлось убрать параметр <span style=" font-family:'Courier New,courier';">keepalive</span>, а в клиентском конфиге добавить <span style=" font-family:'Courier New,courier';">ping-restart 0</span>.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic;">Дополнение:</span> Вы можете держать OpenVPN и веб-серер (например, <a href="https://eax.me/nginx/"><span style=" text-decoration: underline; color:#0000ff;">Nginx</span></a>) на одном порту. Для этого веб-сервер должен слушать, к примеру, 127.0.0.1:4443, а у OpenVPN в конфиге следом за <span style=" font-family:'Courier New,courier';">port 443</span> нужно написать <span style=" font-family:'Courier New,courier';">port-share 127.0.0.1 4443</span>. Конкретно порт 443 интересен тем, что на нем обычно <a href="https://eax.me/lets-encrypt/"><span style=" text-decoration: underline; color:#0000ff;">живет HTTPS</span></a>. Поэтому интернет-провайдеры редко режут или как-то модифицируют трафик, идущий на этот порт. Если держать VPN на другом порту, он может оказаться недоступен по Wi-Fi в каком-нибудь кафе или аэропорте.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic;">Дополнение:</span> Вас также могут заинтересовать статьи, посвященные <a href="https://eax.me/sshuttle/"><span style=" text-decoration: underline; color:#0000ff;">sshuttle</span></a> и <a href="https://eax.me/tor/"><span style=" text-decoration: underline; color:#0000ff;">Tor</span></a>. А из поста про <a href="https://eax.me/raspberry-pi-wifi-router/"><span style=" text-decoration: underline; color:#0000ff;">роутер на базе Raspberry Pi</span></a> вы узнаете, как можно завернуть в VPN сетевой трафик сразу всех ваших устройств. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic;">Метки: </span><a href="https://eax.me/tag/linux/"><span style=" font-style:italic; text-decoration: underline; color:#0000ff;">Linux</span></a><span style=" font-style:italic;">, </span><a href="https://eax.me/tag/security/"><span style=" font-style:italic; text-decoration: underline; color:#0000ff;">Безопасность</span></a><span style=" font-style:italic;">.</span></p></body></html>