<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#c00202;"><br />Скетч универсального web-сервера с файлами на SD карте. Ethernet Shield W5100</span></p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" width="100%" cellspacing="0" cellpadding="15" bgcolor="#c0c0c0">
<tr>
<td colspan="2" bgcolor="#ffffff" style=" padding-top:5; padding-bottom:5;">
<p style="-qt-paragraph-type:empty; margin-top:7px; margin-bottom:0px; margin-left:7px; margin-right:7px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p>
<p align="center" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt; font-weight:600;">Универсальный web - сервер на Arduino</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">     Этот сервер хранит HTML файлы и рисунки на SD - карте. Для его функционирования необходим Ethernet Shield W5100 (</span><a href="http://nnov.3dn.ru/misc/cx5100.pdf"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt; text-decoration: underline; color:#c00202;">схема</span></a><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">) , который устанавливается с помощью разъемов на контроллере Arduino.  </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">  </span></p>
<p align="center" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1676216016re5zpkxywx.png" /></p>
<p align="center" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">Рис.1. Arduino Ethernet Shield W5100</span></p>
<p align="center" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;"> </span></p>
<p align="justify" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">      Arduino Ethernet Shield позволяет подключить плату Arduino к сети. Она основана на Ethernet –микросхеме Wiznet W5100. Wiznet W5100 поддерживает стеки TCP/IP and UDP в IP-сети. Он поддерживает до четырёх одновременных подключений к сокетам. Для создания скетчей (программ), которые подключают Arduino к сети при помощи данной платы,  используется библиотека Ethernet. Данная плата соединяется с платой Arduino при помощи длинных штырьков, проходящих через неё. Это позволяет не изменять расположение выводов и устанавливать другие платы поверх неё. Плата Ethernet Shield имеет стандартный разём RJ-45.</span></p>
<p align="justify" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">     Последние версии платы имеют разъём для карт типа micro-SD, которые могут использоваться для хранения файлов и работы с ними по сети. Плата совместима также с Arduino Uno и Mega (при использовании библиотеки Ethernet library). Разъем microSD доступен при помощи библиотеки SD Library. При применении этой библиотеки вывод 4 Arduino используется для сигнала SS (Slave Select).</span></p>
<p align="justify" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">      Последние версии платы  имеют улучшенный  сброс, что позволяет быть уверенным в перезапуске W5100 после включения. Предыдущие версии платы были не совместимы с Arduino Mega и требовали также ручного сброса после включения путем нажатия на клавишу RESET.  При подключении компьютера через адаптер FTDI-USB, Arduino и Ethernet Shield получают питание от адаптера.</span></p>
<p align="justify" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">     Arduino осуществляет связь с W5100 и картой SD посредством шины SPI (через разъём ICSP header). Эта шина расположена на выводах 11, 12, и 13 платы Arduino UNO и выводах 50, 51, и 52 Arduino Mega. На обеих платах вывод № 10 используется для выбора W5100, а ввод № 4 - для карты SD. Эти выводы не могут быть использованы для другого ввода-вывода. На плате Mega, аппаратный вывод SS № 53 не используется для выбора ни W5100, ни карты SD,  но он должен быть сконфигурирован на вывод, иначе интерфейс SPI может не работать.</span></p>
<p align="justify" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">      Микросхема W5100 и карта SD разделяют шину SPI, поэтому одновременно они работать  не могут. Если используются оба этих периферийных устройства в программе, следует использовать соответствующие им библиотеки.  Если не используется ни одно из этих периферийных устройств, следует явно отключить их. Чтобы сделать это,  необходимо сконфигурировать  вывод платы № 4 для SD как выход и записать в него &quot;1&quot;. Для W5100 необходимо установить на выводе № 10 также &quot;1&quot;. </span></p>
<p align="justify" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt; font-weight:600;">Ниже представлен текст программы универсального web-сервера</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">#include &lt;SPI.h&gt;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">#include &lt;Ethernet.h&gt;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">#include &lt;SD.h&gt;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">byte mac[] = {0xDE, 0xAD, 0xBE, 0xEF, 0xFE, 0xED };</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">IPAddress ip(192,168,1,100);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">char rootFileName[] = &quot;index.htm&quot;;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">EthernetServer server(80);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">File myFile;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">void setup() {</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">  SD.begin(4);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">  Serial.begin(9600);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">  Serial.println(&quot;Free RAM: &quot;);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">  Serial.println(FreeRam());</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">  pinMode(10, OUTPUT);                    // установить SS вывод как выходящий</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">  digitalWrite(10, HIGH);                    // Выключить чип w5100</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">  // Запускаем сервер. По умолчанию шлюз выбран 192.168.1.1, маска 255.255.255.0</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">  Ethernet.begin(mac, ip);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">  server.begin();</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">// Выбираем размер буфера 100 символов, где находится имя файла.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">#define BUFSIZ 100</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">void loop()</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">{</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">  char clientline[BUFSIZ];</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">  char *filename;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">  int index = 0;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">  EthernetClient client = server.available();</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">    if (client) {</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">    // an http request ends with a blank line</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">    boolean current_line_is_blank = true;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">    // reset the input buffer</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">    index = 0;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">      while (client.connected()) {</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">        if (client.available()) {</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">          char c = client.read();</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">        // Сбросить соединение, если пришел непонятный символ от клиента.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">        //Например, наблюдались зависания от браузера</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">        // Safary (IPad 2), который посылал &quot;непонятные&quot; символы</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">        if ( c==0x0A || c==0x0D ) goto aa;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">        if ( c&lt;0x20 || c&gt;0x7E ) break;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">   aa:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">      // Если символ от клиента правильный, записываем его в буфер</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">       // Если идет чтение не новой строки, то продолжаем ее символы записывать в буфер.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">        if (c != '\n' &amp;&amp; c != '\r') {</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">          clientline[index] = c;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">          index++;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">          // Идем на продолжение считывать новый символ.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">          continue;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">        }</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">   // Заканчиваем строку символом 0, если следующая строка новая (получили  \n или \r )</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">        clientline[index] = 0;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">        filename = 0;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">        // Распечатываем прочитанную строку.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">        Serial.println(clientline);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">        // Look for substring such as a request to get the root file</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">        if (strstr(clientline, &quot;GET / &quot;) != 0) {</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">          filename = rootFileName;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">        }</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">        if (strstr(clientline, &quot;GET /&quot;) != 0) {</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">          // this time no space after the /, so a sub-file</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">          if (!filename) filename = clientline + 5; // look after the &quot;GET /&quot; (5 chars)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">          // a little trick, look for the &quot; HTTP/1.1&quot; string and</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">          // turn the first character of the substring into a 0 to clear it out.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">          (strstr(clientline, &quot; HTTP&quot;))[0] = 0;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">          // print the file we want</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">          Serial.println(filename);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">         myFile = SD.open(filename);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">          if (!myFile ) {</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">            client.println(&quot;HTTP/1.1 404 Not Found&quot;);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">            client.println(&quot;Content-Type: text/html&quot;);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">            client.println();</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">            client.println(&quot;&lt;h2&gt;File Not Found!&lt;/h2&gt;&quot;);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">            break;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">          }</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">          Serial.println(&quot;Opened!&quot;);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">           client.println(&quot;HTTP/1.1 200 OK&quot;);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">           if (strstr(filename, &quot;.htm&quot;) != 0)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">             client.println(&quot;Content-Type: text/html&quot;);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">         else if (strstr(filename, &quot;.css&quot;) != 0)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">             client.println(&quot;Content-Type: text/css&quot;);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">         else if (strstr(filename, &quot;.png&quot;) != 0)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">             client.println(&quot;Content-Type: image/png&quot;);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">          else if (strstr(filename, &quot;.jpg&quot;) != 0)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">             client.println(&quot;Content-Type: image/jpeg&quot;);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">         else if (strstr(filename, &quot;.gif&quot;) != 0)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">             client.println(&quot;Content-Type: image/gif&quot;);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">         else if (strstr(filename, &quot;.3gp&quot;) != 0)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">             client.println(&quot;Content-Type: video/mpeg&quot;);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">         else if (strstr(filename, &quot;.pdf&quot;) != 0)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">             client.println(&quot;Content-Type: application/pdf&quot;);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">         else if (strstr(filename, &quot;.js&quot;) != 0)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">             client.println(&quot;Content-Type: application/x-javascript&quot;);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">         else if (strstr(filename, &quot;.xml&quot;) != 0)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">             client.println(&quot;Content-Type: application/xml&quot;);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">         else</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">             client.println(&quot;Content-Type: text&quot;);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">          client.println();</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">  byte cB[64];</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">  int cC=0;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">    while (myFile.available())</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">       {</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">         cB[cC]=myFile.read();</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">         cC++;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">       if(cC &gt; 63)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">        {</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">         client.write(cB,64);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">        cC=0;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">        }</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">       }</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">      if(cC &gt; 0) client.write(cB,cC);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">       myFile.close();</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">        } else {</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">          // everything else is a 404</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">          client.println(&quot;HTTP/1.1 404 Not Found&quot;);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">          client.println(&quot;Content-Type: text/html&quot;);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">          client.println();</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">          client.println(&quot;&lt;h2&gt;File Not Found!&lt;/h2&gt;&quot;);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">           }</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">        break;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">      }</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">    }</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">    // give the web browser time to receive the data</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">    delay(1);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">    client.stop();</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">  }</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">}</span></p>
<p align="justify" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">    Необходимо учитывать следующее. Веб - сервер на Arduino не использует многопользовательскую мультипрограммную операционную систему. Поэтому при обращении одного клиента передача данных будет идти только к нему. Второй клиент начнет получать данные только после закрытия соединения с первым клиентом. Поэтому большая HTML страница должна быть разбита на маленькие, которые быстро загружаются и сервер закрывает соединение. Благодаря этому может появиться возможность обращению к серверу 2-3 клиентов почти одновременно. Примерно через 10-15 минут интенсивного обращения к серверу он зависает (по опыту виснет Ethernet Shield W5100).</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt; background-color:#ffffff;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt; background-color:#ffffff;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt; background-color:#ffffff;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:7px; margin-bottom:0px; margin-left:7px; margin-right:7px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p></td></tr>
<tr>
<td colspan="2" style=" padding-top:3; padding-bottom:5;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,sans-serif'; font-size:8pt; color:#1a1a1a;">Категория: </span><a href="https://nnov.3dn.ru/publ/39"><span style=" font-family:'Tahoma,Arial,sans-serif'; font-size:8pt; text-decoration: underline; color:#c00202;">Arduino</span></a><span style=" font-family:'Tahoma,Arial,sans-serif'; font-size:8pt; color:#1a1a1a;"> | Добавил: </span><a href="javascript:;"><span style=" font-family:'Tahoma,Arial,sans-serif'; font-size:8pt; text-decoration: underline; color:#c00202;">БОТ</span></a><span style=" font-family:'Tahoma,Arial,sans-serif'; font-size:8pt; color:#1a1a1a;"> (18.11.2015)</span></p></td></tr>
<tr>
<td colspan="2" style=" padding-top:3; padding-bottom:5;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Tahoma,Arial,sans-serif'; font-size:8pt; color:#1a1a1a;">Просмотров: </span><span style=" font-family:'Tahoma,Arial,sans-serif'; font-size:8pt; font-weight:600; color:#1a1a1a;">7660</span><span style=" font-family:'Tahoma,Arial,sans-serif'; font-size:8pt; color:#1a1a1a;"> | Рейтинг: </span><span style=" font-family:'Tahoma,Arial,sans-serif'; font-size:8pt; font-weight:600; color:#1a1a1a;">0.0</span><span style=" font-family:'Tahoma,Arial,sans-serif'; font-size:8pt; color:#1a1a1a;">/</span><span style=" font-family:'Tahoma,Arial,sans-serif'; font-size:8pt; font-weight:600; color:#1a1a1a;">0</span></p></td></tr></table>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" width="100%" cellspacing="0" cellpadding="10" bgcolor="#c0c0c0">
<tr>
<td width="60%">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;">Всего комментариев: </span><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt; font-weight:600;">0</span><span style=" font-family:'verdana,arial,helvetica'; font-size:8pt;"><br /></span></p></td></tr></table></body></html>