<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu'; font-size:xx-large; font-weight:600;">Решение задачи: как починить «сломанный» VPS на Linux </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Ubuntu';" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://habr.com/ru/company/ruvds/"><span style=" text-decoration: underline; color:#0000ff;">Блог компании RUVDS.com</span></a>, </li>
<li style=" font-family:'Ubuntu';" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://habr.com/ru/hub/s_admin/"><span style=" text-decoration: underline; color:#0000ff;">Серверное администрирование</span></a> </li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="post-content-body"></a><span style=" font-family:'Ubuntu';">З</span><span style=" font-family:'Ubuntu';">акончился наш конкурс «как починить сломанный VPS на </span><a href="https://ruvds.com/linux"><span style=" font-family:'Ubuntu'; text-decoration: underline; color:#0000ff;">Linux server</span></a><span style=" font-family:'Ubuntu';">». </span><a href="https://habrahabr.ru/company/ruvds/blog/307976/"><span style=" font-family:'Ubuntu'; text-decoration: underline; color:#0000ff;">Задачей</span></a><span style=" font-family:'Ubuntu';"> участников было починить «сломанный» </span><a href="https://ruvds.com"><span style=" font-family:'Ubuntu'; text-decoration: underline; color:#0000ff;">VPS сервер</span></a><span style=" font-family:'Ubuntu';"> на linux. C задачей смогли справиться лишь двое участников конкурса. Победитель справился с задачей за 17 часов. <br /><br />» Участник с почтой </span><span style=" font-family:'Ubuntu'; font-weight:600;">farst***@gmail.com</span><span style=" font-family:'Ubuntu';"> получает главный приз — VPS-сервер (5x2.6ГГц, 5 ГБ RAM, 50 ГБ SSD) на год. <br />» Участник с почтой </span><span style=" font-family:'Ubuntu'; font-weight:600;">non7*****@gmail.com</span><span style=" font-family:'Ubuntu';"> занимает второе место — ему мы даём пожизненную скидку в 70% на виртуальные сервера RUVDS и нашу фирменную кружку. Ну а решение под катом.<br /><br /></span><img src="image917681069.png" /><span style=" font-family:'Ubuntu';"><br /></span><a name="habracut"></a><span style=" font-family:'Ubuntu';"><br /></span><span style=" font-family:'Ubuntu'; font-style:italic;">Всем остальным участникам конкурса мы дарим скидку 10% на виртуальные сервера от </span><a href="https://ruvds.com"><span style=" font-family:'Ubuntu'; font-style:italic; text-decoration: underline; color:#0000ff;">RUVDS</span></a><span style=" font-family:'Ubuntu'; font-style:italic;">. Чтобы получить скидку напишите письмо на support@ruvds.com укажите свой логин</span><span style=" font-family:'Ubuntu';">.<br /><br />Итак, выкладываем решение задачи.<br /><br /></span></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu'; font-size:x-large; font-weight:600; color:#3ac1ef;">Решение</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';"><br /></span><span style=" font-family:'Ubuntu'; font-weight:600;">1.</span><span style=" font-family:'Ubuntu';"> Используем аварийный режим, подключаемся под пользователем administrator.<br /><br /></span><span style=" font-family:'Ubuntu'; font-weight:600;">2.</span><span style=" font-family:'Ubuntu';"> Монтируем root fs с правами на запись (файловая система монтируется в таком режиме, так как файл /etc/fstab был переименован в /etc/fstab_backup<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">sudo mount -o remount,rw /dev/sda3 /</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">sudo mv /etc/fstab_backup /etc/fstab</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';"><br /></span><span style=" font-family:'Ubuntu'; font-weight:600;">3.</span><span style=" font-family:'Ubuntu';"> Разрешаем входящие подключения на 80 и 22 порты:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">sudo ufw allow 80</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">sudo ufw allow 22</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';"><br /></span><span style=" font-family:'Ubuntu'; font-weight:600;">4.</span><span style=" font-family:'Ubuntu';"> Отключаем swap:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">sudo swapoff -a</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';"><br />В fstab комментируем соотвествующую строку: <br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">sudo vim /etc/fstab</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">#UUID=1dc65039-4ac4-xxxxx-xxx-4xxxxf96xxxx none            swap    sw              0       0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';"><br /></span><span style=" font-family:'Ubuntu'; font-weight:600;">5.</span><span style=" font-family:'Ubuntu';"> Форматируем swap в xfs (или в любую другую файловую систему), например используя утилиту mkfs -t xfs<br /><br /></span><span style=" font-family:'Ubuntu'; font-weight:600;">6.</span><span style=" font-family:'Ubuntu';"> Удаляем ненужное из текущей инсталляции для того, чтобы её можно было скопировать на раздел /dev/sda2<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">sudo apt-get autoremove</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">sudo apt-get remove name-of-package --purge #для ненужных пакетов</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">sudo rm -rf /var/log</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">sudo rm -rf /tmp/*</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';"><br /></span><span style=" font-family:'Ubuntu'; font-weight:600;">7.</span><span style=" font-family:'Ubuntu';"> Монтируем /dev/sda2 в /mnt и копируем необходимые файлы из корневого раздела и файлы конкурса.<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">sudo mount /dev/sda2 /mnt</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">cp -dpRx / /mnt</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';"><br /></span><span style=" font-family:'Ubuntu'; font-weight:600;">8.</span><span style=" font-family:'Ubuntu';"> Получаем uuid /dev/sda2:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">sudo blkid /dev/sda2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';"><br /></span><span style=" font-family:'Ubuntu'; font-weight:600;">9.</span><span style=" font-family:'Ubuntu';"> Указываем новое значение для root, обновляем uuid в /etc/grub/grub.cfg<br /><br /></span><span style=" font-family:'Ubuntu'; font-weight:600;">10.</span><span style=" font-family:'Ubuntu';"> Загружаемся под новым корневым разделом<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">shutdown -r now</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Ubuntu';"><br /></span><span style=" font-family:'Ubuntu'; font-weight:600;">11.</span><span style=" font-family:'Ubuntu';"> Удаляем (xfs не поддерживает shrink) раздел /dev/sda3 и разбиваем его на 2 (/dev/sda3 и /dev/sda4) в соответствии с условиями задачи. Это можно сделать с помощью fdisk.<br /><br /></span><span style=" font-family:'Ubuntu'; font-weight:600;">12.</span><span style=" font-family:'Ubuntu';"> Форматируем новые разделы в xfs (утилита mkfs -t xfs)<br /><br /></span><span style=" font-family:'Ubuntu'; font-weight:600;">13.</span><span style=" font-family:'Ubuntu';"> Монтируем раздел /dev/sda3 и копируем туда файлы необходимые файлы корневого раздела.<br /><br /></span><span style=" font-family:'Ubuntu'; font-weight:600;">14.</span><span style=" font-family:'Ubuntu';"> Монтируем раздел /dev/sda4 и копируем туда файлы конкурса<br /><br /></span><span style=" font-family:'Ubuntu'; font-weight:600;">15.</span><span style=" font-family:'Ubuntu';"> Снова правим /etc/grub/grub.cfg и прописываем там новый uuid (нового раздела /dev/sda3) и устройство.<br /><br /></span><span style=" font-family:'Ubuntu'; font-weight:600;">16.</span><span style=" font-family:'Ubuntu';"> Правим fstab и перезагружаемся.<br /><br /></span><span style=" font-family:'Ubuntu'; font-weight:600;">17.</span><span style=" font-family:'Ubuntu';"> Помечаем раздел /dev/sda2 снова в качестве swap (раскомментируем запись в fstab, устанавливаем идентификатор swap через fdisk и выполняем swapon)<br /><br /></span><span style=" font-family:'Ubuntu'; font-weight:600;">18.</span><span style=" font-family:'Ubuntu';"> Перезагружаем ваш </span><a href="https://ruvds.com"><span style=" font-family:'Ubuntu'; text-decoration: underline; color:#0000ff;">VPS</span></a><span style=" font-family:'Ubuntu';">, настраиваем сайт в nginx и открываем браузер, и видим наш сайт, задача решена:<br /></span></p></body></html>