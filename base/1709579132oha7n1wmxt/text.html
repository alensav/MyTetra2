<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:10px; margin-bottom:5px; margin-left:51px; margin-right:36px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">Ivan Grishaev's blog</span></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:51px; margin-right:36px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'PT Serif,serif'; font-size:small; color:#111111;">Writing on programming, education, books and negotiations.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:51px; margin-right:36px; -qt-block-indent:0; text-indent:0px;"><a href="https://grishaev.me/"><span style=" font-family:'PT Serif,serif'; font-size:14pt; color:#2a7ae2;">Home</span></a><a href="https://grishaev.me/about/"><span style=" font-family:'PT Serif,serif'; font-size:14pt; color:#2a7ae2;">About</span></a><a href="https://grishaev.me/bookshelf/"><span style=" font-family:'PT Serif,serif'; font-size:14pt; color:#2a7ae2;">Bookshelf</span></a><a href="https://grishaev.me/feed.xml"><span style=" font-family:'PT Serif,serif'; font-size:14pt; color:#2a7ae2;">RSS</span></a></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:51px; margin-right:36px; -qt-block-indent:0; text-indent:0px;"><a href="https://grishaev.me/tag/clojure/"><span style=" font-family:'PT Serif,serif'; font-size:12pt; color:#000000;">Clojure</span></a><a href="https://grishaev.me/tag/emacs/"><span style=" font-family:'PT Serif,serif'; font-size:12pt; color:#000000;">Emacs</span></a><a href="https://grishaev.me/tag/python/"><span style=" font-family:'PT Serif,serif'; font-size:12pt; color:#000000;">Python</span></a><a href="https://grishaev.me/tag/programming/"><span style=" font-family:'PT Serif,serif'; font-size:12pt; color:#000000;">Programming</span></a><a href="https://grishaev.me/interview/"><span style=" font-family:'PT Serif,serif'; font-size:12pt; color:#000000;">Interview</span></a><a href="https://grishaev.me/video/"><span style=" font-family:'PT Serif,serif'; font-size:12pt; color:#000000;">Video</span></a></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:51px; margin-right:36px; -qt-block-indent:0; text-indent:0px;"><a href="https://grishaev.me/clojure-in-prod/"><span style=" font-family:'PT Serif,serif'; font-size:12pt; color:#000000; background-color:#ffff00;">Книга «Clojure на производстве»</span></a></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:51px; margin-right:36px; -qt-block-indent:0; text-indent:0px;"><a href="https://grishaev.me/clojure-in-prod-2/"><span style=" font-family:'PT Serif,serif'; font-size:12pt; color:#000000; background-color:#ffff00;">Книга «Clojure на производстве», второй том</span></a></p>
<p style=" margin-top:10px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:1%;"><span style=" font-family:'PT Serif,serif'; font-size:xx-large; font-weight:600; color:#111111;">Crontab и отправка почты</span></p>
<p style=" margin-top:0px; margin-bottom:5px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#828282;">Jun 23, 2021 </span><a href="https://grishaev.me/tag/programming/"><span style=" font-family:'PT Serif,serif'; font-size:19px; text-decoration: underline; color:#2a7ae2;">programming</span></a><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#828282;">, </span><a href="https://grishaev.me/tag/cron/"><span style=" font-family:'PT Serif,serif'; font-size:19px; text-decoration: underline; color:#2a7ae2;">cron</span></a><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#828282;">, </span><a href="https://grishaev.me/tag/mail/"><span style=" font-family:'PT Serif,serif'; font-size:19px; text-decoration: underline; color:#2a7ae2;">mail</span></a></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">На днях столкнулся с проблемой. На моем ноуте крутится несколько crontab-задач. Хотелось бы видеть, когда сработала каждая из них и если нет, то почему. Какое-то время я выкручивался с помощью логов. Оба канала (stdout и stderr) перехватываются в общий пайп, где каждая строка предваряется текущий датой и записывается в файл. Например:</span></p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Courier New,courier'; font-size:19px; color:#008080; background-color:#000000;">SHELL</span><span style=" font-family:'Courier New,courier'; font-size:19px; font-weight:600; color:#111111; background-color:#000000;">=</span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">/bin/bash</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">0 </span><span style=" font-family:'Courier New,courier'; font-size:19px; font-weight:600; color:#111111; background-color:#000000;">*</span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">/3 </span><span style=" font-family:'Courier New,courier'; font-size:19px; font-weight:600; color:#111111; background-color:#000000;">*</span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;"> </span><span style=" font-family:'Courier New,courier'; font-size:19px; font-weight:600; color:#111111; background-color:#000000;">*</span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;"> </span><span style=" font-family:'Courier New,courier'; font-size:19px; font-weight:600; color:#111111; background-color:#000000;">*</span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;"> /path/to/command &amp;&gt; </span><span style=" font-family:'Courier New,courier'; font-size:19px; font-weight:600; color:#111111; background-color:#000000;">&gt;(</span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;"> </span><span style=" font-family:'Courier New,courier'; font-size:19px; font-weight:600; color:#111111; background-color:#000000;">while </span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#0086b3; background-color:#000000;">read </span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">line; </span><span style=" font-family:'Courier New,courier'; font-size:19px; font-weight:600; color:#111111; background-color:#000000;">do </span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#0086b3; background-color:#000000;">echo</span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;"> </span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#dd1144; background-color:#000000;">&quot;$(</span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#0086b3; background-color:#000000;">date</span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#dd1144; background-color:#000000;">): </span><span style=" font-family:'Courier New,courier'; font-size:19px; font-weight:600; color:#111111; background-color:#000000;">${</span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#008080; background-color:#000000;">line</span><span style=" font-family:'Courier New,courier'; font-size:19px; font-weight:600; color:#111111; background-color:#000000;">}</span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#dd1144; background-color:#000000;">&quot;</span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">; </span><span style=" font-family:'Courier New,courier'; font-size:19px; font-weight:600; color:#111111; background-color:#000000;">done</span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;"> </span><span style=" font-family:'Courier New,courier'; font-size:19px; font-weight:600; color:#111111; background-color:#000000;">&gt;&gt;</span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;"> /Users/ivan/logs/command.log</span><span style=" font-family:'Courier New,courier'; font-size:19px; font-weight:600; color:#111111; background-color:#000000;">)</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:19px; font-weight:600; color:#111111; background-color:#000000;"><br /></pre>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">В результате и обычный, и ошибочный выхлоп оседают в файле. Выглядит это так:</span></p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">Tue Jun 22 15:58:02 MSK 2021: warning: Skipping file ...</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">Tue Jun 22 15:58:19 MSK 2021: Completed 0 file(s) with ...</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">Tue Jun 22 15:59:02 MSK 2021: warning: Skipping file /Users/ivan/...</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">Tue Jun 22 15:59:19 MSK 2021: Completed 0 file(s) with ...</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;"><br /></pre>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">Недостаток в том, что логи нужно регулярно проверять. Об этом легко забыть на месяц, а потом выяснится, что задача не работала из-за глупой ошибки.</span></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">Тут я вспомнил, что крон умеет отправлять выхлоп задачи на почту. Если задана переменная </span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">MAILTO=&lt;email&gt;</span><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">, то на эту почту свалится выхлоп. Это значит, отпадают логи, ведь теперь достаточно проверить почту. Проверять ее можно и с телефона, что в разы удобней.</span></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">Отправка письма работает за счет утилиты </span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">mail</span><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">. В общем виде ей пользуются так:</span></p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Courier New,courier'; font-size:19px; color:#0086b3; background-color:#000000;">cat </span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">something | mail </span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#000080; background-color:#000000;">-s</span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;"> </span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#dd1144; background-color:#000000;">'subject'</span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;"> friend@domain.com</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;"><br /></pre>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">Эта команда отправит письмо на сервер </span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">domain.com</span><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">, при этом отправитель будет выглядеть как </span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">ivan@ivan.local</span><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">, то есть имя пользователя и текущего хоста. То же самое можно получить командой:</span></p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">echo `whoami`@`hostname`</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;"><br /></pre>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">Обратите внимание на кавычки – они означают выполнить выражение в новом шелле и подставить результат.</span></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">Отправленное письмо никто не получит, что потому что современные сервера отметают письма, где айпи отправителя не совпадает с айпи его домена. Это хорошо, иначе бы мы утонули в спаме. Будем отправлять письма с серверов Гугла. А чтобы </span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">mail</span><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;"> мог подключиться к Гуглу, сделаем три вещи.</span></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'PT Serif,serif'; font-size:19px; font-weight:600; color:#111111;">Первое.</span><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;"> В файл </span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">/etc/postfix/main.cf</span><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;"> дописать строки ниже. Делать это нужно под </span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">sudo</span><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">:</span></p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">relayhost = [smtp.gmail.com]:587</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">smtp_sasl_auth_enable = yes</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">smtp_sasl_security_options = noanonymous</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">smtp_use_tls = yes</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">smtp_sasl_mechanism_filter = plain</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;"><br /></pre>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'PT Serif,serif'; font-size:19px; font-weight:600; color:#111111;">Второе.</span><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;"> Создать файл </span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">/etc/postfix/sasl_passwd</span><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;"> и вписать в него:</span></p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">[smtp.gmail.com]:587 username@gmail.com:password</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;"><br /></pre>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">, где </span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">password</span><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;"> — пароль приложения для почты. Сгенерить этот пароль можно на специальной </span><a href="https://myaccount.google.com/apppasswords"><span style=" font-family:'PT Serif,serif'; font-size:19px; text-decoration: underline; color:#2a7ae2;">странице Гугла</span></a><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">.</span></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">Замечу, что вместо </span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">gmail.com</span><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;"> может быть ваш домен, если он нацелен на гугловые сервера как в моем случае.</span></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'PT Serif,serif'; font-size:19px; font-weight:600; color:#111111;">Третье</span><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;"> — указать </span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">postfix</span><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;"> новые конфиги и перезагрузить его:</span></p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">sudo chmod 600 /etc/postfix/sasl_passwd</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">sudo postmap /etc/postfix/sasl_passwd</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">sudo launchctl stop org.postfix.master</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">sudo launchctl start org.postfix.master</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;"><br /></pre>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">Все. Пробуем отправить письмо. Сообщим в нем содержимое домашней папки:</span></p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Courier New,courier'; font-size:19px; color:#0086b3; background-color:#000000;">ls</span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;"> </span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#000080; background-color:#000000;">-l</span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;"> | mail </span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#000080; background-color:#000000;">-s</span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;"> </span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#dd1144; background-color:#000000;">'my home dir'</span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;"> ivan@grishaev.me</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;"><br /></pre>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">Мне пришло с первого раза. Plain text, красота.</span></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">Так вот, теперь когда почта работает, настроим крон. Открываем его командой </span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">crontab -e</span><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;"> и пишем сверху:</span></p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">MAILTO=&lt;ваша@почта&gt;</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;"><br /></pre>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">Кроме того, в конец каждой команды добавляем эхо, например:</span></p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">0 */3 * * * cd /some/path &amp;&amp; command --foo 42 &amp;&amp; echo OK</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;"><br /></pre>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">Зачем нужно эхо? Оказалось, что крон не отправляет письмо, если выхлоп задачи пуст. А поскольку я всегда хочу знать о запуске задачи, то делаю вывод не пустым. Вместо </span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">echo OK</span><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;"> можно вывести текущую дату с помощью </span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">&amp;&amp; date</span><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">.</span></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">В результате мы получим письмо, где тема — команда задачи, а тело — ее выхлоп. Работает в том числе и для задач, которые не сработали из-за ошибки.</span></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">Я уж не говорю о том, что с помощью </span><span style=" font-family:'Courier New,courier'; font-size:19px; color:#111111; background-color:#000000;">mail</span><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;"> можно быстро что-то скидывать себе на почту, организовать какие-то заметки и прочее. Что самое прекрасное — нет интерфейса, все простое и открытое, работает везде. Чудо.</span></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">В следующий раз расскажу, что именно я ставлю на крон, там тоже интересные вещи.</span></p>
<p align="center" style=" margin-top:0px; margin-bottom:15px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'PT Serif,serif'; font-size:small; color:#111111;">Нашли ошибку? Выделите мышкой и нажмите Ctrl/⌘+Enter</span></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">Комментарии</span></p>
<p style=" margin-top:10px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px;"><a name="comments"></a><span style=" font-family:'PT Serif,serif'; font-size:small; font-style:italic; color:#111111;">А</span><span style=" font-family:'PT Serif,serif'; font-size:small; font-style:italic; color:#111111;">нтон, 23rd Jun 2021,</span><span style=" font-family:'PT Serif,serif'; font-size:small; font-style:italic; color:#111111;"> </span><a href="https://grishaev.me/cron-mail/#comment-5430205897"><span style=" font-family:'PT Serif,serif'; font-size:small; font-style:italic; text-decoration: underline; color:#2a7ae2;">link</span></a></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">Иван, а смотри, по моему опыту проблема в том что регулярно письма падают, глаз замыливается а в один день письмо не приходит, и это заметить сложнее, чем в обратной ситуации - когда по дефолту все ок, а в случае проблемы приходит письмо.</span></p>
<p style=" margin-top:0px; margin-bottom:15px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'PT Serif,serif'; font-size:19px; color:#111111;">Я аналогичную проблему решал сервисом (ставили селфхостед, но можно обойтись и SaaS, бесплатным аккаунтом) - </span><a href="https://healthchecks.io/"><span style=" font-family:'PT Serif,serif'; font-size:19px; text-decoration: underline; color:#2a7ae2;">https://healthchecks.io/</span></a></p></body></html>